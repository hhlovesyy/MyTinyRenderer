# ç©ºé—´åŠ é€Ÿç»“æ„

æ¥è‡ªPBRTï¼šç»å¤§å¤šæ•°ç°åœ¨çš„ray tracerséƒ½ä½¿ç”¨K-Dæ ‘æˆ–è€…æ˜¯BVHæ ‘ï¼Œåœ¨æœ¬ç¯‡ä¸­ä¼šå®ç°å…«å‰æ ‘,K-Dæ ‘ä»¥åŠBVHæ ‘ã€‚

è¿™ä¸ªé—®é¢˜çš„å‡ ä¸ªé«˜èµå›ç­”å€¼å¾—çœ‹çœ‹ï¼šhttps://www.zhihu.com/question/48905832/answer/2664911942

# ä¸€ã€Octreeå…«å‰æ ‘

åŸç†å¾ˆå®¹æ˜“ç†è§£ï¼Œå¦‚ä¸‹å›¾ï¼š

![img](./assets/v2-bf40fe51233e2e82f68ea33a2aeaaadf_r.jpg)

æˆ‘ä»¬æœ‰ä¸€ä¸ªBoxï¼Œå°†è¿™ä¸ªBoxå…«ç­‰åˆ†ï¼ˆX,Y,Zæ–¹å‘å„å¯¹åŠåˆ†ï¼‰ï¼Œé‚£æˆ‘ä»¬å°±æœ‰äº†å…«ä¸ªå­Boxï¼ˆ$2^3$ä¸ªï¼‰ã€‚å¦‚æœæˆ‘ä»¬å†æŠŠè¿™å…«ä¸ªå†åˆ’åˆ†ä¸€ä¸‹ï¼Œé‚£å°±èƒ½å¾—åˆ°64ä¸ªBox($2^6$ä¸ª)ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¾€å¾€ä¸ä¼šå¯¹æ‰€æœ‰å­èŠ‚ç‚¹æ— å·®åˆ«çš„åˆ’åˆ†ï¼Œè€Œæ˜¯æ»¡è¶³â€œä¸€å®šæ¡ä»¶â€çš„å­èŠ‚ç‚¹ï¼Œæ‰ä¼šè¢«å†æ¬¡åˆ’åˆ†ã€‚

## 1.å…«å‰æ ‘çš„æ•°æ®ç»“æ„

å¯¹äºæ¯ä¸€ä¸ª`node`ï¼Œå…¶ä»£è¡¨äº†ä¸€ä¸ªå­ç©ºé—´ã€‚å¯¹boxè€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`center`å’Œ`size`æ¥å®šä¹‰è¿™ä¸ªç©ºé—´ï¼Œæ­¤æ—¶åˆ¤æ–­æŸä¸€ç‚¹$P$æ˜¯å¦åŒ…å«åœ¨`node`å†…çš„é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚å¯ä»¥è¿™æ ·åˆ¤æ–­ï¼š

```c#
bool isInSideNode(Vector3 pos)
{
    return abs(pos.x-center.x)<size.x/2.0 && abs(pos.y-center.y)<size.y/2.0 && abs(pos.z-center.z)<size.z/2.0;
}
```

åœ¨åé¢çš„ä»£ç ä¸­ï¼Œä¹Ÿä¼šçœ‹åˆ°è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚

æ ¹æ®ä¸Šè¿°çŸ¥è¯†ï¼Œæˆ‘ä»¬å®šä¹‰å…«å‰æ ‘çš„NodeèŠ‚ç‚¹ä»¥åŠå…¶æ„é€ å‡½æ•°ï¼š

```c#
namespace SpaceAccelerateDemo
{
    public class OctreeNode
    {
        public List<GameObject> areaObjects;
        public Vector3 center;
        public float size; //ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œè¿™é‡Œå®šä¹‰æ¯ä¸ªnodeéƒ½æ˜¯æ­£æ–¹ä½“ï¼Œå› æ­¤ç”¨ä¸€ä¸ªfloatå€¼å³å¯å­˜å‚¨size
        
        private const int kidCount = 8; //å…«å‰æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰8ä¸ªå­èŠ‚ç‚¹
        private OctreeNode[] kids;
        public OctreeNode(Vector3 center, float size)
        {
            this.center = center;
            this.size = size;
            areaObjects = new List<GameObject>();
            kids = new OctreeNode[kidCount];
        }
    }
}
```

ä¸€äº›åŸºæœ¬çš„é€»è¾‘å‡½æ•°ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸¤ä¸ªï¼š

```c#
public bool isLeaf => kids[0] == null;
        
public bool Contains(Vector3 position)
{
    var halfSize = size * 0.5f;
    return Mathf.Abs(position.x - center.x) <= halfSize &&
           Mathf.Abs(position.y - center.y) <= halfSize &&
           Mathf.Abs(position.z - center.z) <= halfSize;
}
```

è¿˜éœ€è¦ä¸€ä¸ªDrawGizmosçš„å‡½æ•°ï¼Œæ–¹ä¾¿åé¢åšå¯è§†åŒ–çš„æ—¶å€™ç”¨ï¼š

```c#
public void DrawGizmos()
{
    Gizmos.DrawWireCube(center, Vector3.one * size);
}
```

å…·ä½“è¿˜æœ‰å“ªäº›åˆ«çš„ï¼Œå¯ä»¥çœ‹æºä»£ç `OctreeNode.cs`ã€‚



## 2.OctreeTest

åˆšæ‰çš„å…«å‰æ ‘åªæ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶è¿›è¡Œç®¡ç†ã€‚è¿™é‡Œç®€å•èµ·è§ï¼Œåªå¢åŠ ä¸€ä¸ª`OctreeTest.cs`æ–‡ä»¶ç”¨äºæµ‹è¯•å…«å‰æ ‘ç©ºé—´åŠ é€Ÿç»“æ„ï¼ŒOctreeTest.csä¸­åŒ…å«äº†å…«å‰æ ‘æµ‹è¯•çš„å‰©ä½™é€»è¾‘ã€‚æˆ‘ä»¬éšæœºç”Ÿæˆä¸€äº›Cubeï¼Œç”¨äºæµ‹è¯•ï¼š

```c#
private void GenSceneObjects()
{
    float genRange = range * 0.5f;
    sceneObjects = new List<GameObject>();
    for (int i = 0; i < genCount; i++)
    {
        var obj = GameObject.CreatePrimitive(PrimitiveType.Cube);
        obj.transform.position = new Vector3(Random.Range(-genRange, genRange), Random.Range(-genRange, genRange), Random.Range(-genRange, genRange));
        obj.hideFlags = HideFlags.HideInHierarchy; //éšè—åœ¨Hierarchyé¢æ¿
        sceneObjects.Add(obj);
    }
}
```

> ä¸ºäº†é˜²æ­¢ä¸é‡è¦çš„å†…å®¹å¹²æ‰°é˜…è¯»ï¼Œè¿™ç¯‡æ–‡ç« ä¸­åªå±•ç¤ºæ¯”è¾ƒæ ¸å¿ƒçš„ä»£ç ï¼Œå…¨éƒ¨çš„ä»£ç å¯ä»¥çœ‹SpaceAccelerationå­æ–‡ä»¶å¤¹ä¸­çš„ã€‚

æ­¤æ—¶è¿è¡Œç¨‹åºï¼Œä¼šäº§ç”Ÿè®¸å¤šéšæœºä½ç½®çš„Cubeã€‚æ¥ä¸‹æ¥ä¾¿æ˜¯å¯¹ä»–ä»¬è¿›è¡Œåˆ’åˆ†ã€‚



### ï¼ˆ1ï¼‰å…«å‰æ ‘åˆ’åˆ†ç®—æ³•

![img](./assets/v2-8a256fe6e0cd7683d626c74001e2610b_r.jpg)

å¤§è‡´çš„ç®—æ³•å¦‚ä¸‹ï¼š

- ï¼ˆaï¼‰å¦‚æœå½“å‰ç”Ÿæˆé€’å½’æ·±åº¦å°äºå®šä¹‰æœ€å¤§é€’å½’æ·±åº¦ï¼Œ åˆ™ä»ã€å½“å‰èŠ‚ç‚¹ã€‘åˆ›å»º8ä¸ªã€å­èŠ‚ç‚¹ã€‘ï¼›
- ï¼ˆbï¼‰éå†ã€å½“å‰èŠ‚ç‚¹ã€‘ä¸­è®°å½•çš„åœºæ™¯å¯¹è±¡ï¼Œå°†å¯¹è±¡åˆ†é…åˆ°å¯¹åº”çš„ã€å­èŠ‚ç‚¹ã€‘ä¸­ï¼›
- ï¼ˆcï¼‰å½“å‰æ·±åº¦å‡ä¸€ï¼Œéå†ã€å­èŠ‚ç‚¹ã€‘ï¼Œå°è¯•æ‰§è¡Œæ­¥éª¤1ã€‚ç›´åˆ°ã€å­èŠ‚ç‚¹ã€‘ä¸­çš„ç‰©ä½“æ•°é‡å°äºç­‰äº1ï¼Œæˆ–è€…é€’å½’æ·±åº¦è¾¾åˆ°æœ€å¤§é€’å½’æ·±åº¦ï¼›

ä»£ç å¦‚ä¸‹ï¼ˆå…¶ä¸­OctreePartion()å‡½æ•°åœ¨Startå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼‰ï¼š

```c#
private void OctreePartion()
{
    root = new OctreeNode(Vector3.zero, range);
    root.areaObjects.AddRange(sceneObjects);
    BuildOctree(root, 0);
}

private void BuildOctree(OctreeNode node, int depth)
{
    if (depth >= buildDepth)
    {
        return;
    }
    if (node.objectCount <= 1)
    {
        return;
    }
    var halfSize = node.size * 0.5f;
    for (int i = 0; i < 8; i++)
    {
        var center = node.center;
        //æ ¹æ®içš„äºŒè¿›åˆ¶ä½æ¥åˆ¤æ–­æ˜¯åœ¨å·¦è¿˜æ˜¯å³,å‰è¿˜æ˜¯å,ä¸Šè¿˜æ˜¯ä¸‹,i=0~7åˆ†åˆ«æ˜¯000ï¼Œ001ï¼Œ010ï¼Œ011ï¼Œ100ï¼Œ101ï¼Œ110ï¼Œ111
        center.x += (i & 1) == 0 ? halfSize * 0.5f : -halfSize * 0.5f;
        center.y += (i & 2) == 0 ? halfSize * 0.5f : -halfSize * 0.5f;
        center.z += (i & 4) == 0 ? halfSize * 0.5f : -halfSize * 0.5f;
        var newNode = new OctreeNode(center, halfSize);
        node.Kids[i] = newNode;
        newNode.areaObjects = node.areaObjects.FindAll(obj => newNode.Contains(obj.transform.position));
        BuildOctree(newNode, depth + 1);
    }
}
```



### ï¼ˆ2ï¼‰å¯è§†åŒ–

å®Œæˆäº†ä¸Šè¿°çš„å…«å‰æ ‘åˆ’åˆ†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶å¯è§†åŒ–å‡ºæ¥ã€‚åœ¨Testè„šæœ¬ä¸­å®šä¹‰ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¡¨ç¤ºdebugçš„æ¨¡å¼ï¼š

```c#
public enum OctreeDebugMode
{
    AllDepth,
    TargetDepth
}
```

æ­¤æ—¶ä¸ºTestæ–‡ä»¶æ·»åŠ ä¸€ä¸ªDrawGizmosçš„å‡½æ•°(ç»§æ‰¿äºMonobehavior)ï¼š

```c#
private void DrawOctree(OctreeNode node, int depth)
{
    //AllDepth:ç»˜åˆ¶æ‰€æœ‰æ·±åº¦çš„å…«å‰æ ‘
    if (octreeDebugMode == OctreeDebugMode.AllDepth)
    {
        node.DrawGizmos();
        if (node.isLeaf)
        {
            return; 
        }
        for (int i = 0; i < 8; i++)
        {
            DrawOctree(node.Kids[i], depth + 1);
        }
    }
    //TargetDepth:ç»˜åˆ¶ç›®æ ‡æ·±åº¦çš„å…«å‰æ ‘
    else if (octreeDebugMode == OctreeDebugMode.TargetDepth)
    {
        Gizmos.color = Color.yellow;
        if (depth == targetDisplayDepth)
        {
            Gizmos.color = Color.green;
            node.DrawGizmos();
        }
        if (node.isLeaf)
        {
            return;
        }
        for (int i = 0; i < 8; i++)
        {
            DrawOctree(node.Kids[i], depth + 1);
        }
    }
}

private void OnDrawGizmos()
{
    if (root == null || !debugDraw)
    {
        return;
    }
    DrawOctree(root,0);
}
```

æ­¤æ—¶è¿è¡Œç¨‹åºï¼Œç”¨2Dæ­£äº¤ç›¸æœºå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœï¼š

ï¼ˆ1ï¼‰é¦–å…ˆæ˜¯AllDepthï¼š

![image-20241219200140357](./assets/image-20241219200140357.png)<img src="./assets/image-20241225133850406.png" alt="image-20241225133850406" style="zoom:80%;" />

> çœ‹èµ·æ¥æœ‰çš„æ ¼å­é‡Œç‰©ä½“æ•°é‡æ¯”è¾ƒå¤šæ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯2DæŠ•å½±çš„ç»“æœï¼Œå®é™…åº”è¯¥æ˜¯ä¸‰ç»´çš„ï¼›

ï¼ˆ2ï¼‰targetDepth=3ï¼Œè¿™æ¬¡ç”¨ä¸‰ç»´æ¥çœ‹ï¼š

![image-20241219200338797](./assets/image-20241219200338797.png)



## 3.å…«å‰æ ‘çš„ä½œç”¨ï¼šåœºæ™¯æŸ¥è¯¢

æˆ‘ä»¬å·²ç„¶æœ‰äº†åŠ é€Ÿç»“æ„ï¼Œä½†æ˜¯æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸€ä¸ªå¾ˆç›´è§‚çš„ä½œç”¨å°±æ˜¯â€œåœºæ™¯æŸ¥è¯¢â€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å·²çŸ¥æœ‰ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„åæ ‡ï¼Œæƒ³çŸ¥é“åœºæ™¯ä¸­çš„ç‰©ä½“ï¼Œå“ªäº›ä¸è¿™ä¸ªæ£€æŸ¥ç‚¹å¾ˆæ¥è¿‘ï¼Œæ„å‘³ç€å…¶å¯èƒ½å‘ç”Ÿç¢°æ’ã€‚

ä¸ºäº†åšæµ‹è¯•ï¼Œæ–°å¢ä¸€äº›å˜é‡ï¼š

```c#
public bool doQueryTest = false;
public Transform queryTransform;
private List<GameObject> queryObjects; //ä¸´è¿‘ç‰©ä½“çš„åˆ—è¡¨ï¼Œç”¨äºæ‰¾åˆ°æœ€è¿‘çš„ç‰©ä½“
private OctreeNode queryNode; //æŸ¥è¯¢åˆ°çš„æœ€ç»ˆèŠ‚ç‚¹ï¼Œä¼šé€’å½’æ‰¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œå°†å…¶å¯è§†åŒ–ä¸ºç»¿è‰²
```

æ­¤æ—¶æŸ¥è¯¢çš„å‡½æ•°å¦‚ä¸‹ï¼š

```c#
private void Update()
{
    if (doQueryTest)
    {
        if(queryObjects != null)
            queryObjects.Clear();
        queryObjects = new List<GameObject>();
        queryNode = null;
        QueryNearestObject(root, queryTransform.position);
    }
}

private void QueryNearestObject(OctreeNode node, Vector3 position)
{
    if (node.isLeaf) //ä¸€ç›´æ‰¾åˆ°å¶å­èŠ‚ç‚¹
    {
        queryNode = node;
        queryObjects.AddRange(node.areaObjects);
        return;
    }
    for (int i = 0; i < 8; i++)
    {
        if (node.Kids[i].Contains(position))
        {
            QueryNearestObject(node.Kids[i], position);  //çœ‹çœ‹å“ªä¸ªå­èŠ‚ç‚¹ä¸­æœ‰è¿™ä¸ªç‰©ä½“ï¼Œæœ‰çš„è¯å†èµ°åˆ°å­èŠ‚ç‚¹
        }
    }
}
```

OnDrawGizmoså‡½æ•°ä¹Ÿè¦æ›´æ–°ï¼Œå¦‚æœæœ‰QueryNodeçš„è¯ï¼Œå°±æ‰¾åˆ°å½“å‰QueryNodeä¸‹æ‰€æœ‰åŒ…å«ç‰©ä½“ä¸­è·ç¦»targetæœ€è¿‘çš„ç‰©ä½“ï¼Œè¿ä¸€æ¡çº¢è‰²çš„çº¿è¿‡å»ã€‚



### ï¼ˆ1ï¼‰å¯è§†åŒ–æ•ˆæœ

ä¸‹é¢çš„åŠ¨å›¾å±•ç¤ºäº†å…«å‰æ ‘æŸ¥è¯¢æ—¶çš„ä¼˜åŠ¿ï¼ˆè®©æ‰€æœ‰ç”Ÿæˆçš„Cubeçš„y=0ï¼Œç”¨2Dä¿¯è§†å›¾æ¥å¯è§†åŒ–ç»“æœï¼‰ï¼š

<video src="./assets/OctreeTreeDemo.mp4"></video>

## 4.æ•´ä¸ªåœºæ™¯

æ•´ä¸ªåœºæ™¯éå¸¸ç®€å•ï¼Œå¦‚ä¸‹ï¼š

![image-20241219204757984](./assets/image-20241219204757984.png)

å…¶ä¸­Sphereæ˜¯è¦æŸ¥è¯¢çš„ç‰©ä½“ã€‚å¯¹åº”çš„ä»£ç åœ¨SpaceAccelerationæ–‡ä»¶å¤¹ä¸‹é¢ã€‚

> å…¶ä»–å…³äºOctreeçš„å‚è€ƒèµ„æ–™ï¼šhttps://www.gameres.com/665565.htmlã€‚ä¸€äº›å…³é”®è¯ï¼š
>
> - æ¾æ•£å…«å‰æ ‘ï¼š
>   - æ¸¸æˆä¸­ç”¨çš„å…«å‰æ ‘å¸¸å¸¸æ˜¯[æ¾æ•£å…«å‰æ ‘](https://zhida.zhihu.com/search?content_id=514615747&content_type=Answer&match_order=1&q=æ¾æ•£å…«å‰æ ‘&zhida_source=entity)ï¼Œå°±æ˜¯å­èŠ‚ç‚¹çš„èŒƒå›´ä¼šæ¯”æ­£å¸¸çš„èŒƒå›´ç•¥å¾®å¤§ä¸€åœˆï¼Œè¿™æ ·å¦‚æœç‰©ä½“å’Œåˆ†å‰²è½´ç›¸äº¤ï¼Œä¹Ÿå¯ä»¥æ”¾åˆ°å­èŠ‚ç‚¹ä¸‹ã€‚
>
>
> https://www.zhihu.com/question/48905832/answer/2664911942



ã€todoã€‘å…«å‰æ ‘çš„åŠ¨æ€æ›´æ–°ï¼šå¦‚æœç‰©ä½“çš„ä½ç½®æ”¹å˜äº†ï¼Œå…«å‰æ ‘è¦æ€ä¹ˆæ›´æ–°ï¼Ÿ

> 1. - æ¾æ•£å…«å‰æ ‘åœ¨å¤„ç†ç‰©ä½“ç§»åŠ¨é—®é¢˜æ—¶ï¼Œé‡‡å–äº†è¾ƒä¸ºé«˜æ•ˆå’Œç®€æ´çš„ç­–ç•¥ï¼š
>
>      1. **ç‰©ä½“ä½ç½®æ›´æ–°**ï¼šå½“ç‰©ä½“ç§»åŠ¨æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­ç‰©ä½“çš„ä¸­å¿ƒç‚¹æ˜¯å¦è¶…å‡ºäº†å…¶å½“å‰æ‰€åœ¨èŠ‚ç‚¹çš„â€œå…¥å£è¾¹ç•Œâ€ï¼ˆinner boundaryï¼‰ã€‚å¦‚æœè¶…å‡ºäº†ï¼Œæ‰éœ€è¦å°†å…¶ä»å½“å‰èŠ‚ç‚¹ç§»é™¤ã€‚
>      2. **é¿å…é¢‘ç¹è°ƒæ•´**ï¼šæ¾æ•£å…«å‰æ ‘çš„â€œå‡ºå£è¾¹ç•Œâ€ï¼ˆouter boundaryï¼‰æ¯”â€œå…¥å£è¾¹ç•Œâ€å®½ï¼Œé€šå¸¸æ˜¯å…¥å£è¾¹ç•Œçš„ä¸¤å€ã€‚è¿™æ„å‘³ç€å³ä½¿ç‰©ä½“åœ¨è¾¹ç•Œé™„è¿‘ç§»åŠ¨ï¼Œä¹Ÿè¾ƒéš¾è¶…å‡ºå‡ºå£è¾¹ç•Œï¼Œä»è€Œå‡å°‘äº†ç‰©ä½“é¢‘ç¹æ›´æ¢èŠ‚ç‚¹çš„æƒ…å†µã€‚
>      3. **å¿«é€Ÿé‡æ–°å®šä½**ï¼šå½“ç‰©ä½“ç¡®å®éœ€è¦ç§»åŠ¨åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œç”±äºæ¾æ•£å…«å‰æ ‘çš„ç‰¹æ€§ï¼Œå¯ä»¥å¿«é€Ÿç¡®å®šæ–°çš„åˆé€‚èŠ‚ç‚¹ã€‚åªéœ€æ ¹æ®ç‰©ä½“æ–°çš„ä¸­å¿ƒä½ç½®å’Œå½“å‰å±‚çº§çš„èŠ‚ç‚¹èŒƒå›´ï¼Œç›´æ¥æ’å…¥åˆ°æ–°çš„èŠ‚ç‚¹ä¸­ï¼Œè¿™ä¸€è¿‡ç¨‹é€šå¸¸å¯ä»¥åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦å†…å®Œæˆã€‚
>      4. **å‡å°‘å†—ä½™æ£€æµ‹**ï¼šé€šè¿‡è¿™ç§è®¾è®¡ï¼Œå‡å°‘äº†åœ¨æŸ¥è¯¢ç¢°æ’æˆ–è§†é”¥ä½“å‰”é™¤æ—¶éœ€è¦æ£€æŸ¥çš„ç‰©ä½“æ•°é‡ï¼Œå› ä¸ºå¤§éƒ¨åˆ†ç‰©ä½“ä¸ä¼šå› ä¸ºè½»å¾®çš„ç§»åŠ¨è€Œé¢‘ç¹æ”¹å˜æ‰€å±èŠ‚ç‚¹ã€‚
>      5. **åŠ¨æ€æ›´æ–°ç®€åŒ–**ï¼šå¯¹äºåŠ¨æ€åœºæ™¯ï¼Œç‰©ä½“ç§»åŠ¨åï¼Œåªéœ€ç®€å•æ£€æŸ¥å¹¶æ›´æ–°å…¶åœ¨æ ‘ä¸­çš„ä½ç½®ï¼Œè€Œä¸éœ€è¦å¯¹æ•´ä¸ªå…«å‰æ ‘ç»“æ„è¿›è¡Œå¤§è§„æ¨¡çš„é‡æ„ï¼Œå¤§å¤§ç®€åŒ–äº†åŠ¨æ€ç®¡ç†çš„å¤æ‚åº¦ã€‚
>
>      å› æ­¤ï¼Œæ¾æ•£å…«å‰æ ‘é€šè¿‡æ‰©å¤§èŠ‚ç‚¹è¦†ç›–èŒƒå›´ï¼Œç®€åŒ–äº†åŠ¨æ€ç‰©ä½“çš„ç®¡ç†ï¼Œæé«˜äº†æ¸¸æˆå’Œæ¨¡æ‹Ÿåœºæ™¯ä¸­ç‰©ä½“ç§»åŠ¨å¤„ç†çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚



# äºŒã€BVH Tree

å‚è€ƒæ–‡ç« ï¼šhttps://zhuanlan.zhihu.com/p/697130257

PBRTåŸæ–‡ä»è¿™é‡Œå¼€å§‹çœ‹ï¼šhttps://pbr-book.org/4ed/Primitives_and_Intersection_Acceleration/Aggregates

ä»¥ä¸‹æ˜¯ä¸€äº›ä¸ç©ºé—´åŠ é€Ÿå’ŒBVH æ ‘çš„ç¿»è¯‘ï¼š

> å¤§ä½“ä¸Šï¼Œè§£å†³è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼šç©ºé—´ç»†åˆ†å’Œå¯¹è±¡ç»†åˆ†ã€‚
>
> - ç©ºé—´ç»†åˆ†ç®—æ³•å°†ä¸‰ç»´ç©ºé—´åˆ†è§£ä¸ºåŒºåŸŸï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡åœ¨åœºæ™¯ä¸Šå åŠ ä¸€ä¸ªè½´å¯¹é½çš„ç›’å­ç½‘æ ¼ï¼‰å¹¶è®°å½•å“ªäº›åŸå§‹å›¾å½¢ä¸å“ªäº›åŒºåŸŸé‡å ã€‚åœ¨æŸäº›ç®—æ³•ä¸­ï¼ŒåŒºåŸŸä¹Ÿå¯ä»¥æ ¹æ®é‡å çš„åŸå§‹å›¾å½¢æ•°é‡è¿›è¡Œè‡ªé€‚åº”ç»†åˆ†ã€‚å½“éœ€è¦æ‰¾åˆ°å…‰çº¿äº¤ç‚¹æ—¶ï¼Œè®¡ç®—å…‰çº¿ç»è¿‡çš„è¿™äº›åŒºåŸŸçš„åºåˆ—ï¼Œå¹¶ä»…æµ‹è¯•ä¸é‡å åŒºåŸŸä¸­çš„åŸå§‹å›¾å½¢çš„äº¤ç‚¹ã€‚
> - ç›¸åï¼Œå¯¹è±¡ç»†åˆ†æ˜¯åŸºäºé€æ­¥å°†åœºæ™¯ä¸­çš„å¯¹è±¡åˆ†è§£ä¸ºè¾ƒå°çš„ç›¸é‚»å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªæˆ¿é—´çš„æ¨¡å‹å¯èƒ½è¢«åˆ†è§£ä¸ºå››é¢å¢™ã€ä¸€ä¸ªå¤©èŠ±æ¿å’Œä¸€æŠŠæ¤…å­ã€‚å¦‚æœå…‰çº¿æ²¡æœ‰ä¸æˆ¿é—´çš„åŒ…å›´ä½“ç›¸äº¤ï¼Œåˆ™å¯ä»¥å‰”é™¤å®ƒçš„æ‰€æœ‰åŸå§‹å›¾å½¢ã€‚å¦åˆ™ï¼Œå°†å¯¹æ¯ä¸ªåŸå§‹å›¾å½¢è¿›è¡Œæµ‹è¯•ã€‚å¦‚æœå…‰çº¿å‡»ä¸­æ¤…å­çš„åŒ…å›´ä½“ï¼Œåˆ™å¯èƒ½ä¼šå¯¹å…¶æ¯æ¡è…¿ã€åº§æ¤…å’Œé èƒŒè¿›è¡Œæµ‹è¯•ã€‚å¦åˆ™ï¼Œæ¤…å­å°†è¢«å‰”é™¤ã€‚
>
> è¿™ä¸¤ç§æ–¹æ³•åœ¨è§£å†³å…‰çº¿äº¤ç‚¹è®¡ç®—è¦æ±‚æ–¹é¢éƒ½éå¸¸æˆåŠŸï¼›æ²¡æœ‰æ ¹æœ¬ç†ç”±åå‘å…¶ä¸­ä¸€ç§ã€‚BVHåŸºäºå¯¹è±¡ç»†åˆ†ï¼Œè€Œ KdTreeåˆ™åŸºäºç©ºé—´ç»†åˆ†ã€‚

BVHæ ‘åœ¨å…‰çº¿è¿½è¸ªå’Œç‰©ç†è§£ç®—çš„æ—¶å€™æœ‰æ¯”è¾ƒå¹¿æ³›çš„åº”ç”¨ã€‚ä½†ä»¥ä¸‹ä¸¤ç§åœºæ™¯å¯èƒ½ä¸é‚£ä¹ˆé€‚åˆç”¨BVHï¼š

- ï¼ˆ1ï¼‰åœºæ™¯éå¸¸ç®€å•ï¼Œåªæœ‰å‡ ä¸ªç‰©ä½“ï¼Œæ­¤æ—¶ç”¨ç©ºé—´åˆ’åˆ†çš„æ–¹æ³•å¯èƒ½æ›´å¥½ï¼Œæ¯”å¦‚å…«å‰æ ‘ï¼ˆæœ‰å¾…å•†æ¦·ï¼‰ï¼›
- ï¼ˆ2ï¼‰åœºæ™¯é¢‘ç¹å‘ç”Ÿå˜åŒ–ï¼ŒBVHæ ‘åœ¨å¤„ç†åŠ¨æ€ç‰©ä½“çš„æ—¶å€™ä¼šå¤æ‚ä¸€äº›ï¼Œå¦‚æœåœºæ™¯é‡Œçš„å„ç§ç‰©å“éƒ½åœ¨æ¥å›ç§»åŠ¨ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨BVHä»¥å¤–çš„ç©ºé—´åŠ é€Ÿç»“æ„ã€‚



## 1.BVHæ ‘çš„åŸºæœ¬åŸç†

æ¥çœ‹ä¸‹é¢çš„å›¾ï¼š

![image-20241223153909591](./assets/image-20241223153909591.png)

å·¦ä¾§æ˜¯åœºæ™¯ï¼Œå³ä¾§åˆ™æ˜¯åŸºäºè¿™ä¸ªåœºæ™¯åˆ›å»ºçš„BVHæ ‘ã€‚å…¶ä¸­ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯æ¯ä¸ªç‰©ä½“è‡ªèº«çš„åŒ…å›´ç›’ï¼Œè€Œéå¶å­èŠ‚ç‚¹ï¼ˆåŒ…å«æ ¹èŠ‚ç‚¹ï¼‰åˆ™å­˜å‚¨çš„æ˜¯å¤§çš„åŒ…å›´ç›’ã€‚æ˜¾ç„¶ï¼Œåœ¨åˆ¤æ–­æ˜¯å¦ç›¸äº¤çš„æ—¶å€™è¦å…ˆæ ¹æ®å¤§çš„åŒ…å›´ç›’åˆ¤æ–­ï¼Œå¦‚æœç›¸äº¤æ‰ä¼šèµ°åˆ°å…¶å­©å­èŠ‚ç‚¹ç»§ç»­åˆ¤æ–­æ˜¯å¦ç›¸äº¤ã€‚

BVHæ„å»ºçš„å‡†åˆ™åœ¨äºï¼š

- æ¯ä¸ªprimitiveï¼ˆå¯ä»¥ç†è§£ä¸ºå›¾å…ƒï¼‰åœ¨å±‚æ¬¡ç»“æ„ä¸­åªå‡ºç°ä¸€æ¬¡ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨ç©ºé—´ç»†åˆ†çš„æ–¹æ³•ä¸­ï¼Œä¸€ä¸ªprimitiveå¯èƒ½ä¼šä¸å¤šä¸ªç©ºé—´åŒºåŸŸé‡å ï¼Œå› æ­¤åœ¨å…‰çº¿ç»è¿‡è¿™äº›åŒºåŸŸæ—¶ï¼Œå¯èƒ½ä¼šè¢«å¤šæ¬¡æµ‹è¯•äº¤ç‚¹ã€‚BVHæ ‘è¿™ä¸€ç‰¹æ€§çš„å¦ä¸€ä¸ªå«ä¹‰æ˜¯ï¼Œç”¨äºè¡¨ç¤ºprimitiveç»†åˆ†å±‚æ¬¡ç»“æ„æ‰€éœ€çš„å†…å­˜é‡æ˜¯æœ‰é™çš„ã€‚**å¯¹äºä¸€ä¸ªåœ¨æ¯ä¸ªå¶å­èŠ‚ç‚¹å­˜å‚¨å•ä¸ªprimitiveçš„äºŒå‰ BVHï¼Œæ€»èŠ‚ç‚¹æ•°ä¸º (2n - 1)ï¼Œå…¶ä¸­ (n) æ˜¯åŸå§‹å›¾å½¢çš„æ•°é‡ã€‚ï¼ˆè¿™é‡Œæœ‰ (n) ä¸ªå¶å­èŠ‚ç‚¹å’Œ (n - 1) ä¸ªå†…éƒ¨èŠ‚ç‚¹ã€‚å¯ä»¥çœ‹ä¸Šé¢å³å›¾è¾…åŠ©ç†è§£ï¼‰**å¦‚æœå¶å­èŠ‚ç‚¹å­˜å‚¨å¤šä¸ªprimitiveï¼Œåˆ™éœ€è¦çš„èŠ‚ç‚¹æ›´å°‘ã€‚

ç›¸å¯¹äºkd-æ ‘æ¥è¯´ï¼ŒBVHæ ‘çš„æ„å»ºæ›´åŠ é«˜æ•ˆï¼Œå¹¶ä¸”é€šå¸¸åœ¨æ•°å€¼ä¸Šæ›´ç¨³å¥ï¼Œè¾ƒå°‘å› èˆå…¥è¯¯å·®å¯¼è‡´æ¼æ‰äº¤ç‚¹ã€‚å› æ­¤ç±»ä¼¼äºPBRTè¿™æœ¬ä¹¦ï¼Œä¼šæŠŠBVHæ ‘ä½œä¸ºé»˜è®¤çš„ç©ºé—´åŠ é€Ÿç»“æ„ã€‚

> **åœ¨æœ¬èŠ‚æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåŸºäºUnityæ„å»ºBVHæ ‘ï¼Œå¹¶å°†å…¶å¯è§†åŒ–å‡ºæ¥ã€‚**

æ„å»ºBVHæ ‘æœ‰ä»¥ä¸‹ç±»å‹ï¼š

- ```c++
  enum class SplitMethod { SAH, HLBVH, Middle, EqualCounts };
  ```

- é»˜è®¤å€¼ SAH è¡¨ç¤ºåº”ä½¿ç”¨åŸºäºâ€œsurface area heuristicâ€çš„ç®—æ³•ï¼ˆåœ¨PBRTç¬¬ 7.3.2 èŠ‚ä¸­è®¨è®ºï¼‰ã€‚å¦ä¸€ç§æ›¿ä»£æ–¹æ¡ˆ HLBVHï¼ˆåœ¨PBRTç¬¬ 7.3.3 èŠ‚ä¸­è®¨è®ºï¼‰å¯ä»¥æ›´é«˜æ•ˆåœ°æ„å»ºï¼ˆå¹¶ä¸”æ›´å®¹æ˜“è¿›è¡Œå¹¶è¡ŒåŒ–ï¼‰ï¼Œä½†å…¶æ„å»ºçš„æ ‘ä¸å¦‚ SAH æœ‰æ•ˆï¼ˆeffectiveï¼‰ã€‚å‰©ä¸‹çš„ä¸¤ç§æ–¹æ³•è®¡ç®—é‡æ›´å°‘ï¼Œä½†åˆ›å»ºçš„æ ‘è´¨é‡ç›¸å¯¹è¾ƒä½ã€‚å®ƒä»¬ä¸»è¦ç”¨äºå¼ºè°ƒå‰ä¸¤ç§æ–¹æ³•çš„ä¼˜è¶Šæ€§ã€‚



## 2.Unityåˆ›å»ºBVHæ ‘

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åˆ›å»ºåŸºæœ¬BVHæ ‘çš„è¿‡ç¨‹å¹¶åšä¸€ä¸ªå°demoï¼Œç„¶åå†å›æ¥è¡¥å……PBRTä¸­çš„å†…å®¹ã€‚ä¸»è¦å‚è€ƒè¿™ç¯‡ï¼šhttps://zhuanlan.zhihu.com/p/697130257ã€‚

### ï¼ˆ1ï¼‰åŒ…å›´ç›’â€”â€”AABB

åœ¨Unityå¯¼å…¥Meshä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶AABBã€‚ç”¨ä¸€ä¸ªcenter+sizeå°±å¯ä»¥è¡¨ç¤ºå‡ºAABBã€‚

![image-20241223162020215](./assets/image-20241223162020215.png)

`Bounds Center`å³ä¸ºAABBåŒ…å›´ç›’çš„ä¸­å¿ƒç‚¹ï¼Œ`Bounds Size`å³ä¸ºè¿™åŒ…å›´ç›’çš„â€œé•¿å®½é«˜â€ã€‚

å¯¹äºä¸€ä¸ªã€ç‰©ä½“Aã€‘çš„ã€åŒ…å›´ç›’Aã€‘ï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹æ€§è´¨ï¼š

1. å¦‚æœæ£€æŸ¥ç‚¹ä¸åœ¨ã€åŒ…å›´ç›’Aã€‘å†…éƒ¨ï¼Œåˆ™æ£€æŸ¥ç‚¹ä¸€å®šä¹Ÿä¸åœ¨ã€ç‰©ä½“Aã€‘å†…éƒ¨ã€‚
2. å¦‚æœå°„çº¿ä¸ä¸ã€åŒ…å›´ç›’Aã€‘ç›¸äº¤ï¼Œåˆ™å°„çº¿ä¸€å®šä¸ä¸ã€ç‰©ä½“Aã€‘ç›¸äº¤ã€‚

ä¾‹å¦‚è¯´åœ¨å…‰çº¿è¿½è¸ªä¸­ï¼Œå…‰çº¿è¦å…ˆå’ŒAABBæ±‚äº¤ï¼Œæ‰ä¼šå»åˆ¤æ–­æ˜¯å¦å’Œç‰©ä½“çš„ä¸‰è§’å½¢é¢ç‰‡ç›¸äº¤ã€‚

**å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨å·¦ä¸‹è§’ï¼ˆminCornerï¼‰å’Œå³ä¸Šè§’ï¼ˆmaxCornerï¼‰æ¥è¡¨ç¤ºä¸€ä¸ªAABBï¼Œè¿™æ ·åšçš„è¯åˆ¤æ–­ä¸¤ä¸ªAABBå–unionæ“ä½œå¯èƒ½æ›´å®¹æ˜“ä¸€äº›ã€‚**

åœ¨C#ä¸­å®šä¹‰AABBçš„åŸºæœ¬ç»“æ„ï¼ˆåœ¨C#ä¸­ï¼Œstructé»˜è®¤æ˜¯å€¼ä¼ é€’ï¼Œclassåˆ™é»˜è®¤æ˜¯å¼•ç”¨ä¼ é€’ï¼‰ï¼š

```c#
public struct AABB
{
    public Vector3 minCorner; //å·¦ä¸‹è§’
    public Vector3 maxCorner;  //å³ä¸Šè§’

    public AABB(Vector3 min, Vector3 max)
    {
        this.minCorner = min;
        this.maxCorner = max;
    }

    public Vector3 Size => maxCorner - minCorner;
    public Vector3 Center => (maxCorner + minCorner) * 0.5f;

}
```

åœ¨BVHæ ‘çš„æ„å»ºä¸­ï¼Œå¯¹ä¸¤ä¸ªAABBå–å¹¶é›†è¿™ä»¶äº‹éå¸¸æœ‰ç”¨ï¼Œè€Œå®é™…ä¸Šå¯¹äºAABBæ¥è¯´ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œmin=min(Aï¼ŒB)ï¼Œmax=maxï¼ˆAï¼ŒBï¼‰å³å¯ã€‚çœ‹ä¸‹å›¾æ›´æœ‰åŠ©äºç†è§£ï¼š

![img](./assets/v2-3c9ce6c05cae7889666046fc017b0ab3_r.jpg)

å°†ä»¥ä¸Šé€»è¾‘å†™æˆä»£ç å°±æ˜¯ï¼š

```c#
public AABB Union(AABB aabb)
{
    minCorner.x = Mathf.Min(minCorner.x, aabb.minCorner.x);
    minCorner.y = Mathf.Min(minCorner.y, aabb.minCorner.y);
    minCorner.z = Mathf.Min(minCorner.z, aabb.minCorner.z);

    maxCorner.x = Mathf.Max(maxCorner.x, aabb.maxCorner.x);
    maxCorner.y = Mathf.Max(maxCorner.y, aabb.maxCorner.y);
    maxCorner.z = Mathf.Max(maxCorner.z, aabb.maxCorner.z);

    return new AABB(minCorner, maxCorner);
}
```

å¦å¤–ï¼ŒAABBè¿˜éœ€è¦ä¸€ä¸ªresetå‡½æ•°ï¼Œä¸€å¼€å§‹è®¤ä¸ºminCorneræ˜¯maxå€¼ï¼ŒmaxCorneræ˜¯minå€¼ï¼Œè¿™æ ·çš„resetä¹‹åçš„AABBè™½ç„¶åœ¨ä»£ç ä¸Šå¹¶ä¸åˆæ³•ï¼Œä½†åœ¨ä¸ä»»ä½•AABBå–å¹¶é›†çš„æ—¶å€™å°±ä¼šå˜æˆå¯¹åº”çš„AABBï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§trickï¼š

```c#
public static AABB Reset()
{
    return new AABB(Vector3.one * float.MaxValue, Vector3.one * float.MinValue);
}
```

ä¸€èˆ¬æ¥è¯´ï¼Œå¹³æ—¶ä½¿ç”¨AABBçš„æ—¶å€™è¿˜å¯èƒ½ä¼šæ¶‰åŠåˆ°å…‰çº¿ä¸AABBæ±‚äº¤ï¼Œä»¥åŠä¸¤ä¸ªAABBçš„æ±‚äº¤é—®é¢˜ï¼Œä½†è¿™é‡Œå…ˆä¸å±•å¼€äº†ã€‚ä¸Šè¿°åŸºç¡€å‡½æ•°å¯¹äºBVHæ ‘çš„åŸºæœ¬æ„å»ºå·²ç»è¶³å¤Ÿäº†ã€‚



### ï¼ˆ2ï¼‰BVH Node

ä¸»è¦é€»è¾‘ä»£ç å¦‚ä¸‹ï¼Œé‡ç‚¹æ˜¯çœ‹InitializeAABBçš„éƒ¨åˆ†ï¼š

```c#
public class BVHNode
{
    public BVHNode leftNode;
    public BVHNode rightNode;
    public BVHNode parent;

    public AABB aabb { get; private set; }
    public List<GameObject> sceneObjects; //BVHèŠ‚ç‚¹åŒ…å«çš„ç‰©ä½“

    #region Debug
    public string Name { get; private set; } //BVHèŠ‚ç‚¹çš„åå­—
    private Color spaceColor; //BVHèŠ‚ç‚¹çš„é¢œè‰²
    #endregion

    private void InitializeAABB()
    {
        this.aabb = AABB.Reset();
        if (sceneObjects == null || sceneObjects.Count==0) return;
        //è®¡ç®—AABB,éå†sceneObjectsï¼Œæ‰¾åˆ°å…¬å…±åŒ…å›´ç›’
        foreach (var obj in sceneObjects)
        {
            var aabb = ComputeWorldAABB(obj);
            this.aabb = this.aabb.Union(aabb);
        }
    }

    public void DumpSceneObject(System.IO.StreamWriter file)
    {
        if (sceneObjects == null) return;
        foreach (var obj in sceneObjects)
        {
            file.WriteLine("    " + obj.name);
        }
    }

    public BVHNode(string name, List<GameObject> objs)
    {
        sceneObjects = objs;
        InitializeAABB();
        Name = name;
        spaceColor = new Color(Random.value, Random.value, Random.value, 0.9f);
    }

    public void UnionAABB(AABB other)
    {
        this.aabb = this.aabb.Union(other);
    }

    public static AABB ComputeWorldAABB(GameObject obj)
    {
        var mesh = obj.GetComponent<MeshFilter>().sharedMesh;
        var localMin = mesh.bounds.min;
        var localMax = mesh.bounds.max;
        var worldMin = obj.transform.TransformPoint(localMin);
        var worldMax = obj.transform.TransformPoint(localMax);
        return new AABB(worldMin, worldMax);
    }

    public void SetLeaf(BVHNode left, BVHNode right)
    {
        leftNode = left;
        rightNode = right;
        if(leftNode!=null) leftNode.parent = this;
        if(rightNode!=null) rightNode.parent = this;
        this.sceneObjects = null;
    }       
}
```

å¦å¤–ï¼Œè·Ÿå…«å‰æ ‘ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦BVHèŠ‚ç‚¹çš„å¯è§†åŒ–é€»è¾‘ï¼š

```c#
public void DrawGizmos()
{
    Gizmos.color = spaceColor;
    Gizmos.DrawWireCube(this.aabb.center, this.aabb.size);
    Gizmos.DrawSphere(this.aabb.minCorner, 0.1f);
    Gizmos.DrawSphere(this.aabb.maxCorner, 0.1f);
}
```

å…¶ä»–æ¶‰åŠåˆ°çš„å‡½æ•°ä¼šåœ¨éœ€è¦çš„æ—¶å€™åšè¡¥å……ã€‚



### ï¼ˆ3ï¼‰BVH Space

è¿™ä¸ªç±»ç”¨äºåˆ’åˆ†ç©ºé—´ä¸­çš„ç‰©ä½“ã€‚ä¸€ç§ç›´è§‚çš„æƒ³æ³•æ˜¯åŸºäºäºŒåˆ†æ¥åšï¼Œæœ¬æ¥äºŒåˆ†å…¶å®è¦æ±‚ç‰©ä½“è¦æ’å¥½åºï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå®ç°å…·ä½“çš„é€»è¾‘ï¼Œé‡ç‚¹æ˜¯çœ‹ä¸‹é¢ä»£ç é‡Œé¢çš„é€’å½’åˆ’åˆ†é˜¶æ®µï¼Œè¿™é‡Œæˆ‘ä»¬é€€å‡ºé€’å½’çš„å¶å­èŠ‚ç‚¹éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼š

- è¾¾åˆ°å¯¹åº”çš„depthå€¼ï¼Œæ¯”å¦‚è¿™é¢—BVHæ ‘åœ¨åˆ›å»ºçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å…è®¸å…¶æœ€å¤šæœ‰5å±‚ï¼Œè¿™æ ·å¯ä»¥ä¼šé€ æˆå¶å­èŠ‚ç‚¹çš„AABBä¸­æœ‰è¶…è¿‡ä¸€ä¸ªç‰©ä½“ï¼›
- å¶å­èŠ‚ç‚¹çš„AABBä¸­åªæœ‰ä¸€ä¸ªç‰©ä½“ï¼Œæ­¤æ—¶ä¸å†åˆ›å»ºå·¦å³å­©å­èŠ‚ç‚¹ã€‚

**å†æ¬¡å¼ºè°ƒï¼ŒBVHçš„éå¶å­èŠ‚ç‚¹ä¸­è™½ç„¶æœ‰AABBçš„ç›¸å…³ä¿¡æ¯ï¼Œä½†å¹¶ä¸åŒ…å«ç‰©ä½“çš„ä¿¡æ¯ï¼Œå› æ­¤åœ¨node.SetLeafå‡½æ•°ä¸­ä¼šæŠŠnodeé‡Œé¢çš„sceneObjectsç½®ä¸ºnullã€‚**

```c++
public class BVHSpace
{
    public BVHNode root { get; private set; }

    public void BuildBVH(List<GameObject> sceneObjects, int depth)
    {
        root = new BVHNode("root", null);
        foreach (var obj in sceneObjects)
        {
            var aabb = BVHNode.ComputeWorldAABB(obj);
            root.UnionAABB(aabb);
        }

        BinaryPartition(root, sceneObjects, 0, sceneObjects.Count, depth);
    }

    //äºŒåˆ†é€’å½’åˆ’åˆ†
    private void BinaryPartition(BVHNode node, List<GameObject> objs, int startIndex, int endIndex, int depth)
    {
        if ( (node.sceneObjects!=null && node.sceneObjects.Count == 1) || depth <=0) return;

        //è®¡ç®—äºŒåˆ†ä¸‹æ ‡
        var halfIndex = (endIndex + startIndex) / 2;
        //æŠŠå¯¹åº”çš„ç‰©ä½“åˆ†é…åˆ°å·¦å³å­èŠ‚ç‚¹
        var leftNode = new BVHNode(node.Name + "_leftKid_" + depth.ToString(), new List<GameObject>(objs.GetRange(startIndex, halfIndex - startIndex)));
        var rightNode = new BVHNode(node.Name + "_rightKid_" + depth.ToString(), new List<GameObject>(objs.GetRange(halfIndex, endIndex - halfIndex)));

        node.SetLeaf(leftNode, rightNode);

        //å‰åŠéƒ¨åˆ†é€’å½’
        BinaryPartition(leftNode, objs, startIndex, halfIndex, depth - 1);
        //ååŠéƒ¨åˆ†é€’å½’
        BinaryPartition(rightNode, objs, halfIndex, endIndex, depth - 1);
    }
}
```

> è¡¥å……ï¼šåœ¨è¿™ç¯‡ç¬”è®°å¯¹åº”çš„Githubä»“åº“æºç ä¸­ï¼Œè¿˜æä¾›äº†å°†æ•´æ£µBVHæ ‘å±‚åºéå†åˆ°æ–‡ä»¶ä¸­çš„å‡½æ•°ï¼Œå‡½æ•°å…¥å£æ˜¯`DumpTreeNodeInfos("BVHTree.txt");`ã€‚



### ï¼ˆ4ï¼‰å¯è§†åŒ–ç»“æœ

ç°åœ¨æˆ‘ä»¬åœ¨BVHTest.csæ–‡ä»¶ä¸­éšæœºç”Ÿæˆè‹¥å¹²ç‰©ä½“ï¼Œç„¶åæ„å»ºBVHæ ‘ã€‚å†™ä¸€ä¸ªå‡½æ•°æ¥å¯è§†åŒ–æ¯ä¸€å±‚çš„å„ä¸ªèŠ‚ç‚¹ï¼Œå¹¶åœ¨`OnDrawGizmos`å‡½æ•°ä¸­è°ƒç”¨ã€‚å…·ä½“å¦‚ä¸‹ï¼š
```c#
//BVHTest.cs
private void OnDrawGizmos()
{
    binarySpace?.root?.DrawTargetDepth(displayDepth);
}
```

è€ŒBVHNodeç±»çš„DrawTargetDepthå‡½æ•°å¦‚ä¸‹ï¼ˆè°ƒç”¨çš„DrawGizmoså‡½æ•°å°±æ˜¯ç»˜åˆ¶AABBå‡ºæ¥ï¼‰ï¼š
```c#
public void DrawTargetDepth(int depth)
{
    if (depth <= 0)
    {
        DrawGizmos();
    }
    else
    {
        this.rightNode?.DrawTargetDepth(depth - 1);
        this.leftNode?.DrawTargetDepth(depth - 1);
    }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨é€’å½’çš„æ–¹å¼æŠŠå¯¹åº”å±‚çš„AABBéƒ½ç»˜åˆ¶å‡ºæ¥äº†ã€‚æˆ‘ä»¬å‡è®¾æ•´ä¸ªåœºæ™¯çš„objectsçš„ç”Ÿæˆé¡ºåºæ˜¯ä»å·¦åˆ°å³çš„ï¼ˆæ„å‘³ç€æ˜¯æ’å¥½åºçš„ï¼‰ï¼Œæ­¤æ—¶åœ¨åšäºŒåˆ†ç”ŸæˆBVHå­èŠ‚ç‚¹çš„æ—¶å€™æ•ˆæœä¼šæ¯”è¾ƒå¥½ï¼ˆå› ä¸ºäºŒåˆ†æ³•å¯¹ä½ç½®æ’åºå¥½çš„èŠ‚ç‚¹æ¯”è¾ƒå‹å¥½ï¼‰ï¼ŒåŠ¨å›¾å¯è§†åŒ–å¦‚ä¸‹ï¼š

<video src="./assets/BVHDemo1.mp4"></video>

ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬åœºæ™¯çš„ç‰©ä½“å¹¶æ²¡æœ‰æ’å¥½åºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆäº‹å‘¢ï¼Ÿ

![image-20241223204526122](./assets/image-20241223204526122.png)

å¯ä»¥çœ‹åˆ°ï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰çš„é€»è¾‘æ˜¯æš´åŠ›åœ°äºŒåˆ†æ•´ä¸ªåœºæ™¯çš„ç‰©å“ï¼Œç„¶åä¾æ®ç´¢å¼•å€¼æ”¾åˆ°å­èŠ‚ç‚¹é‡Œé¢ï¼Œåœ¨ä¸Šå›¾çš„æƒ…å†µä¸‹ï¼Œåœºæ™¯objectsåˆ—è¡¨é‡Œé¢çš„ç‰©ä½“å¹¶æ²¡æœ‰æŒ‰é¡ºåºæ’å¸ƒï¼Œè€Œæ˜¯éšæœºæ’å¸ƒï¼Œæ­¤æ—¶æ„å»ºå‡ºæ¥çš„BVHæ ‘ä¼šéå¸¸ç³Ÿç³•ï¼ŒåŸºæœ¬èµ·ä¸åˆ°ä»€ä¹ˆä¼˜åŒ–æ•ˆæœï¼Œä¸‰ç»´æƒ…å†µè§‚å¯Ÿå¦‚ä¸‹å›¾ï¼š

![image-20241223204722589](./assets/image-20241223204722589.png)

### ï¼ˆ5ï¼‰ä¼˜åŒ–â€”â€”AxisPartition

åŸºäºæ•°ç»„ä¸‹æ ‡çš„äºŒåˆ†æ³•å¾—åˆ°çš„AABBå¹¶ä¸å†æ˜¯ä¸€ä¸ªç†æƒ³çš„ç»“æœï¼Œæˆ‘ä»¬æ›´å¸Œæœ›æ¯ä¸€å±‚çš„AABBå°½å¯èƒ½åœ°ä¸ç›¸äº¤ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•èƒ½æ›´å¥½åœ°åšç‰©ä½“çš„åˆ’åˆ†å‘¢ï¼Ÿç†è®ºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿé‰´å…«å‰æ ‘å’ŒKD-æ ‘çš„æ€æƒ³ï¼Œè¯•å›¾åœ¨åæ ‡ä¸Šåšåˆ’åˆ†ã€‚å¯¹äºè½´å‘çš„åˆ’åˆ†ï¼Œå¯ä»¥é€‰æ‹©Xã€Yã€Zä¸‰ä¸ªè½´ã€‚é€‰æ‹©å“ªä¸€ä¸ªè½´å‘¢ï¼Ÿ

> æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°å¦‚ä¸‹äº‹å®ï¼šå¦‚æœè¯´åœºæ™¯ç‰©ä½“çš„xå€¼éå¸¸é›†ä¸­ï¼Œæ¯”å¦‚æ–¹å·®åªæœ‰0.01ï¼Œé‚£ä¹ˆåŸºäºxå€¼çš„åæ ‡äºŒåˆ†ç»“æœçš„AABBä¹Ÿä¼šéå¸¸é›†ä¸­ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„ç»“æœã€‚

ä¾‹å¦‚ï¼š

![img](./assets/v2-84d2aef407c14185590d0b6a165448fc_r.jpg)

ä¸Šå›¾çš„å·¦å³æ˜¯åŒä¸€ä¸ªåœºæ™¯ï¼Œè¿™ä¸ªåœºæ™¯ç‰©ä½“åœ¨xè½´ä¸Šåˆ†å¸ƒçš„éå¸¸é›†ä¸­ï¼Œyè½´åˆ™åˆ†å¸ƒçš„ç›¸å¯¹æ¾æ•£ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨Yè½´ä¸Šè¿›è¡Œåˆ’åˆ†ã€‚åŒæ—¶ï¼Œå¾ˆæ˜æ˜¾èƒ½å¤Ÿçœ‹å‡ºå³ä¾§çš„åˆ’åˆ†è´¨é‡æ¯”å·¦ä¾§æ›´å¥½ã€‚å®é™…ä¸Šï¼Œå¯»æ‰¾æ–¹å·®æœ€å¤§çš„è½´ï¼Œè®¡ç®—ä¸­ç‚¹ï¼Œåˆ†å‰²ç‰©ä½“ï¼Œè¿™æ­£æ˜¯[k-d tree](https://zhida.zhihu.com/search?content_id=243048037&content_type=Article&match_order=1&q=k-d+tree&zhida_source=entity)çš„æ„å»ºç®—æ³•ã€‚å®ƒæ˜¯å’Œå…«å‰æ ‘ä¸€æ ·ï¼Œæ˜¯åŸºäºç©ºé—´çš„åŠ é€Ÿç»“æ„ã€‚è¿™é‡Œæˆ‘ä»¬å€Ÿç”¨å…¶ç®—æ³•æ€æƒ³ï¼Œæ¥ä½œä¸ºBVHçš„æ„å»ºã€‚æ¥çœ‹ä»£ç ï¼Œåœ¨BVHSpaceä¸­æ–°å¢ä»¥ä¸‹å‡½æ•°ï¼ŒåŒæ—¶ä¿®æ”¹BuildBVHå‡½æ•°ï¼Œå¢åŠ å¯¹typeçš„åˆ¤æ–­ï¼š

```c#
//æœ€å¤§æ–¹å·®è½´åˆ†å‰²
private void AxisPartition(BVHNode node, List<GameObject> sceneObjects, int depth)
{
    if ( (node.sceneObjects!=null && node.sceneObjects.Count == 1) || depth <=0) return;

    var leftNodeSceneObjects = new List<GameObject>();
    var rightNodeSceneObjects = new List<GameObject>();

    int mode = PickVariance(sceneObjects);
    float centerMode = node.aabb.Center[mode]; //å¯¹åº”è½´çš„ä¸­å¿ƒ
    foreach (var obj in sceneObjects)
    {
        var objCenter = obj.transform.position[mode];
        if (objCenter < centerMode)
        {
            leftNodeSceneObjects.Add(obj);
        }
        else
        {
            rightNodeSceneObjects.Add(obj);
        }
    }

    var leftNode = new BVHNode(node.Name + "_leftKid_" + depth.ToString(), leftNodeSceneObjects);
    var rightNode = new BVHNode(node.Name + "_rightKid_" + depth.ToString(), rightNodeSceneObjects);
    node.SetLeaf(leftNode, rightNode);
    //é€’å½’
    AxisPartition(leftNode, leftNodeSceneObjects, depth - 1);
    AxisPartition(rightNode, rightNodeSceneObjects, depth - 1);
}

//é€‰æ‹©æ–¹å·®æœ€å¤§çš„è½´
private int PickVariance(List<GameObject> sceneObjects)
{
    var maxVariance = float.MinValue;
    var maxIndex = 0;
    for (int i = 0; i < 3; i++)
    {
        var variance = ComputeVariance(sceneObjects, i);
        if (variance > maxVariance)
        {
            maxVariance = variance;
            maxIndex = i;
        }
    }
    return maxIndex;
}

private float ComputeVariance(List<GameObject> sceneObjects, int axis)
{
    var center = Vector3.zero;
    foreach (var obj in sceneObjects)
    {
        center += obj.transform.position;
    }
    center /= sceneObjects.Count;
    var variance = 0.0f;
    foreach (var obj in sceneObjects)
    {
        variance += Mathf.Pow(obj.transform.position[axis] - center[axis], 2);
    }
    return variance;
}

public void BuildBVH(List<GameObject> sceneObjects, int depth, int type=1)
{
    //...
    if(type==0)
        BinaryPartition(root, sceneObjects, 0, sceneObjects.Count, depth);
    else if(type==1)
        AxisPartition(root, sceneObjects, depth);
}
```

æ­¤æ—¶æˆ‘ä»¬å†éšæœºç”Ÿæˆä¸€äº›ç‰©ä½“ï¼Œç„¶åå¯è§†åŒ–ä¸€ä¸‹BVHæ ‘ï¼Œç»“æœå¦‚ä¸‹ï¼š

![image-20241223210458729](./assets/image-20241223210458729.png)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶çš„åˆ’åˆ†ç»“æœæ¯”å‰é¢ä¸åšç‰¹æ®Šå¤„ç†çš„æ—¶å€™è¦å¥½å¾ˆå¤šã€‚è¿™å°±æ˜¯Axis-Partitionçš„ä½œç”¨ï¼Œè¿™ç§æ€æƒ³åœ¨å›¾å½¢å­¦ä¸­ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚åœ¨å®é™…BVHçš„åº”ç”¨ä¸­ï¼Œå‡è®¾åœºæ™¯æ˜¯é™æ­¢çš„ï¼Œæ„å»ºè¿™æ£µæ ‘åŸºæœ¬æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™å¯ä»¥å¾ˆå¥½èµ·åˆ°åŠ é€Ÿçš„ä½œç”¨ï¼Œå¯¹äºé™æ€åœºæ™¯æ¥è¯´å¯ä»¥å¤§å¤§æå‡å…‰çº¿æ±‚äº¤å’Œç‰©ç†ç¢°æ’è§£ç®—çš„æ•ˆç‡ã€‚



### ï¼ˆ6ï¼‰è¡¥å……

è‡³æ­¤ï¼Œæˆ‘ä»¬æˆåŠŸåœ°æ„å»ºäº†BVHï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æ˜¯â€œè‡ªä¸Šè€Œä¸‹â€[[2\]](https://zhuanlan.zhihu.com/p/697130257#ref_2)çš„æ„å»ºæ–¹å¼ï¼Œæˆ‘ä»¬å¾—æå‰çŸ¥é“åœºæ™¯ä¸­çš„æ‰€æœ‰ç‰©ä½“`List<GameObject>`ã€‚

> **top-down :** [ç¦»çº¿æ¸²æŸ“](https://zhida.zhihu.com/search?content_id=243048037&content_type=Article&match_order=1&q=ç¦»çº¿æ¸²æŸ“&zhida_source=entity)ä¸­æœ€æµè¡Œçš„æ–¹æ³•.å°†æ‰€æœ‰BV(bounding volume)æ”¾åœ¨ä¸€èµ·ç»„æˆæ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨åˆé€‚çš„æ–¹å¼å°†æ ¹èŠ‚ç‚¹åˆ†å‰²æˆä¸¤éƒ¨åˆ†ç»„æˆå­èŠ‚ç‚¹ï¼Œè¿™æ ·[é€’å½’å¼](https://zhida.zhihu.com/search?content_id=243048037&content_type=Article&match_order=1&q=é€’å½’å¼&zhida_source=entity)åœ°å¾ªç¯å¾€ä¸‹åˆ†å‰²ï¼Œæ„æˆå®Œæ•´çš„BVHã€‚
> é€‰æ‹©åˆ†å‰²è½´å’Œåˆ†å‰²ç‚¹çš„æ–¹å¼å¤šç§å¤šæ ·ï¼Œæ¯”å¦‚æœ€ç®€å•çš„ä¸€ç§æ–¹å¼æ˜¯ä»XYZè½´é€‰å–ä¸€ä¸ªæœ€é•¿çš„è½´ä½œä¸ºåˆ†å‰²è½´ï¼Œé€‰å–æ‰€æœ‰BVä¸­å¿ƒç‚¹çš„å¹³å‡ä¸­å¿ƒä½œä¸ºåˆ†å‰²ç‚¹ã€‚
> top-downæ–¹æ³•çš„ä¸€ä¸ªä¼˜åŠ¿æ˜¯å¯ä»¥å®ç°**æ‡’åˆå§‹åŒ–**ï¼Œæ•´ä¸ªBVHåœ¨çœŸæ­£éœ€è¦ç”¨åˆ°çš„æ—¶å€™å†åˆå§‹åŒ–.ä½†æ˜¯ä¹Ÿå› ä¸ºå…¶æ„å»ºæ—¶é—´è¾ƒé•¿ï¼Œå¯¼è‡´å…¶åœ¨[å®æ—¶æ¸²æŸ“](https://zhida.zhihu.com/search?content_id=243048037&content_type=Article&match_order=1&q=å®æ—¶æ¸²æŸ“&zhida_source=entity)ç­‰å¯¹å¸§ç‡æœ‰è¦æ±‚çš„åœ°æ–¹åº”ç”¨ä¸å¤šã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä»‹ç»å¦‚ä½•å¤„ç†åŠ¨æ€åœºæ™¯ï¼Œæ¯”å¦‚æœ‰ç‰©ä½“æ¥å›ç§»åŠ¨ï¼Œè¿™å°±æ¶‰åŠåˆ°äº†ç‰©ä½“çš„åŠ¨æ€æ·»åŠ ä¸åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯åœ¨äºŒã€1éƒ¨åˆ†æåˆ°çš„è¡¨é¢ç§¯å¯å‘ (Surface Area Heuristicï¼ŒSAH)ç®—æ³•ã€‚



## 3.BVHæ ‘è¿›é˜¶â€”â€”åŠ¨æ€ç‰©ä½“å¤„ç†

ä¸»è¦å‚è€ƒé“¾æ¥ï¼šhttps://zhuanlan.zhihu.com/p/697580373ã€‚

ä¸Šä¸€èŠ‚å¾ˆå¥½åœ°å®ç°äº†BVHçš„åŸºæœ¬åˆ›å»ºï¼Œå¹¶ä¸”æˆ‘ä»¬æ„å»ºçš„BVHæ ‘å¯ä»¥å¤„ç†é™æ€åœºæ™¯ã€‚æœ¬èŠ‚å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨â€œæ’å…¥æ„å»ºâ€çš„æ–¹å¼æ¥æ›´æ–°BVHæ ‘ã€‚

### ï¼ˆ1ï¼‰ä¸€äº›çº¦å®š

å†æ¥çœ‹ä¸€ä¸‹è¿™å¼ å›¾ï¼š

![img](./assets/v2-69831729567521862c9e73afaf11558f_r.jpg)

**åœ¨æ’å…¥æ„å»ºçš„æ–¹å¼ä¸‹ï¼Œè§„å®šä¸€ä¸ªåŒ…å›´ä½“åªèƒ½åŒ…å›´ä¸¤ä¸ªå°çš„åŒ…å›´ä½“**ã€‚å› æ­¤ï¼Œåœ¨æœ¬èŠ‚å¯¹åº”çš„ BVH ä¸­ï¼ŒèŠ‚ç‚¹ç±»å‹åªæœ‰ä¸¤ç§[[1\]](https://zhuanlan.zhihu.com/p/697580373#ref_1)ï¼š

- åˆ†æ”¯èŠ‚ç‚¹ï¼ˆBranch Nodeï¼‰ï¼šåŒ…å›´ä¸¤ä¸ª AABB çš„ AABBï¼›
- å¶å­èŠ‚ç‚¹ (Leaf Node) ï¼šåŒ…å›´ä½å®é™…ç‰©ä½“çš„ AABBï¼›

å¯¹äºåŠ¨æ€ä¿®æ”¹BVHæ ‘æ¥è¯´ï¼Œå¸¸è§çš„æ“ä½œæ˜¯ã€åˆå¹¶èŠ‚ç‚¹ã€‘ä¸ã€åˆ†ç¦»èŠ‚ç‚¹ã€‘ï¼Œä»¥ä¸‹åˆ†åˆ«ä»‹ç»ï¼š

### ï¼ˆ2ï¼‰åˆå¹¶èŠ‚ç‚¹

ä¸€èˆ¬çš„ï¼Œåˆå¹¶èŠ‚ç‚¹çš„æ­¥éª¤æ˜¯ï¼Œå·²çŸ¥ä¸€ä¸ªã€ç›®æ ‡å¶å­èŠ‚ç‚¹Aã€‘å’Œä¸€ä¸ªã€è¦åˆå¹¶çš„å¶å­èŠ‚ç‚¹Bã€‘ã€‚å¯ä»¥ç†è§£æˆAæ˜¯ä¸€ä¸ªBVHæ ‘ä¸Šå·²æœ‰çš„å¶å­èŠ‚ç‚¹ï¼Œè€ŒBç°åœ¨å¯èƒ½ä¸åœ¨BVHæ ‘ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨**å…¶ä»–åˆ†æ”¯çš„å¶å­èŠ‚ç‚¹**ä¸Šï¼Œéœ€è¦åˆå¹¶åˆ°Aä¸Šã€‚è¿™æ—¶çš„åšæ³•å¦‚ä¸‹ï¼š

- ï¼ˆaï¼‰å¤åˆ¶èŠ‚ç‚¹Açš„å†…å®¹ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹A'ï¼›
- ï¼ˆbï¼‰è®¡ç®—èŠ‚ç‚¹A'ä¸èŠ‚ç‚¹Bçš„å¹¶é›†AABBï¼Œä½œä¸ºèŠ‚ç‚¹Açš„AABBã€‚ç”±äºèŠ‚ç‚¹Açš„AABBå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦å‘ä¸Šä¼ æ’­æ›´æ–°è¿™ä¸€æ¡é“¾ä¸Šçš„AABBï¼ˆå¦‚æœæœ‰çˆ¶çº§çš„è¯ï¼‰ã€‚
- ï¼ˆcï¼‰æœ€åï¼ŒæŠŠ A' ä¸ B ä½œä¸ºA çš„å­èŠ‚ç‚¹ã€‚

æœ€åæ„å»ºå‡ºæ¥çš„æ ‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå…¶ä¸­èŠ‚ç‚¹Aâ€˜æ˜¯ä»èŠ‚ç‚¹Aå¤åˆ¶å‡ºæ¥çš„ï¼ŒèŠ‚ç‚¹Açš„AABBæ˜¯èŠ‚ç‚¹Aâ€™ä¸ç‰©ä½“Bçš„AABBçš„å¹¶é›†ï¼‰ï¼š

![img](./assets/v2-0d754850de3ce9b7b58003bb52ab3b2a_r.jpg)

æ³¨æ„äº‹é¡¹ï¼š

- ã€ç›®æ ‡å¶å­èŠ‚ç‚¹Aã€‘å’Œä¸€ä¸ªã€è¦åˆå¹¶çš„å¶å­èŠ‚ç‚¹Bã€‘**ä¸èƒ½æ˜¯åˆ†æ”¯èŠ‚ç‚¹**ï¼Œæ­¤æ—¶æ’å…¥èŠ‚ç‚¹ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç°åŸæ¥Açš„çˆ¶èŠ‚ç‚¹çš„æ‰€å±å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåªæ˜¯AèŠ‚ç‚¹å˜æˆäº†ä¸€ä¸ªæ–°çš„â€åˆ†æ”¯èŠ‚ç‚¹â€œï¼Œè€ŒåŸæ¥AèŠ‚ç‚¹çš„å†…å®¹è¢«ä¸‹æ”¾åˆ°å¶å­èŠ‚ç‚¹é‡Œé¢äº†ã€‚

è¶çƒ­æ‰“é“ï¼Œæˆ‘ä»¬æ¥ä¸ºBVHNodeç±»æ·»åŠ éœ€è¦çš„å‡½æ•°ï¼š

```c#
#region ä¸åŠ¨æ€BVHç›¸å…³

public bool isLeaf => this.sceneObjects != null; //åˆ¤æ–­æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹,å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼ŒsceneObjectsä¸ä¸ºç©º

//å¤åˆ¶ä¸€ä¸ªèŠ‚ç‚¹
public BVHNode(BVHNode source)
{
    this.aabb = source.aabb;
    this.sceneObjects = source.sceneObjects;
    this.leftNode = source.leftNode;
    this.rightNode = source.rightNode;
    //æ³¨ï¼šè¿™é‡Œæ²¡æœ‰å¤åˆ¶parentï¼Œå› ä¸ºåœ¨åŠ¨æ€BVHä¸­ï¼Œæ‹·è´å‡ºæ¥çš„èŠ‚ç‚¹çš„parentæœ¬æ¥å°±è¦é‡æ–°è®¾ç½®
    this.Name = source.Name + "_copy";
    this.spaceColor = new Color(Random.value, Random.value, Random.value, 0.9f);
}

//è·å–å…„å¼ŸèŠ‚ç‚¹
public BVHNode GetSibling()
{
    return this.parent?.GetTheOtherNode(this);
}

private BVHNode GetTheOtherNode(BVHNode brother)
{
    if (this.leftNode == brother) return this.rightNode;
    if (this.rightNode == brother) return this.leftNode;
    return null;
}

//æŸ¥æ‰¾æ ¹èŠ‚ç‚¹
private BVHNode FindRoot()
{
    if (this.parent != null)
    {
        return parent.FindRoot();
    }
    return this;
}

//åˆå¹¶ä¸¤ä¸ªèŠ‚ç‚¹,sourcenodeçš„å†…å®¹ä¼šè¢«åˆå¹¶åˆ°targetnodeä¸­
public static BVHNode Merge(BVHNode targetNode, BVHNode sourceNode)
{
    //step1:å¤åˆ¶å‡ºä¸€ä¸ªtargetNodeï¼Œå–åä¸ºcopyNode
    BVHNode copyNode = new BVHNode(targetNode);
    //step2:åˆå¹¶sourceçš„AABBåˆ°targetNode, å¹¶ä¸”æ›´æ–°æ•´æ¡æ ‘çš„é“¾çš„AABB
    targetNode.UnionAABB(sourceNode.aabb);
    targetNode.AABBBroadCast();
    //step3ï¼šå°†targetNodeä½œä¸ºcopyNodeå’ŒsourceNodeçš„çˆ¶èŠ‚ç‚¹
    targetNode.SetLeaf(copyNode, sourceNode);
    return copyNode; //è¿”å›åŸæ¥çš„targetNode
}

private void AABBBroadCast()
{
    if (this.parent != null)
    {
        this.parent.UpdateAABB();
        this.parent.AABBBroadCast();
    }
}

public void UpdateAABB()
{
    this.aabb = AABB.Reset(); //é‡æ–°è®¡ç®—AABBï¼Œå·¦å³èŠ‚ç‚¹çš„AABBæ±‚å¹¶
    if (leftNode != null)
    {
        UnionAABB(leftNode.aabb);
    }

    if (rightNode != null)
    {
        UnionAABB(rightNode.aabb);
    }
}

#endregion
```



### ï¼ˆ3ï¼‰åˆ†ç¦»èŠ‚ç‚¹

<img src="./assets/v2-5a512b1317783297442983d0b43007e8_r.jpg" alt="img" style="zoom:80%;" />

çœ‹ä¸Šå›¾ï¼Œç›¸å½“äºæˆ‘ä»¬è¦æŠŠèŠ‚ç‚¹Bä»è¿™é¢—BVHæ ‘æ‘˜ä¸‹æ¥ï¼Œæ­¤æ—¶çš„æ­¥éª¤å¦‚ä¸‹ï¼š

- ï¼ˆaï¼‰è·å–åˆ°å¾…åˆ†ç¦»çš„èŠ‚ç‚¹ã€Bã€‘çš„ã€çˆ¶èŠ‚ç‚¹ã€‘ä»¥åŠã€å…„å¼ŸèŠ‚ç‚¹Aã€‘ï¼›
- ï¼ˆbï¼‰æŠŠã€å…„å¼ŸèŠ‚ç‚¹Aã€‘çš„å¿…è¦ä¿¡æ¯å¤åˆ¶åˆ°ã€çˆ¶èŠ‚ç‚¹ã€‘é‡Œï¼ŒåŒ…æ‹¬AABBï¼Œåœºæ™¯ç‰©ä½“ä¿¡æ¯ï¼Œå¶å­èŠ‚ç‚¹ä¿¡æ¯ç­‰ï¼›
- ï¼ˆcï¼‰åˆ é™¤ã€èŠ‚ç‚¹Aã€‘å’Œã€èŠ‚ç‚¹Bã€‘ï¼Œå¹¶ä¸”æ²¿ç€æ ‘çš„é“¾ä¸€ç›´å‘ä¸Šæ›´æ–°æ‰€æœ‰çš„AABBã€‚

å¯ä»¥å‘ç°ï¼Œä¸Šé¢çš„æ“ä½œç›¸å½“äºæŠŠæ ‘å‡å°‘äº†ä¸€å±‚ï¼Œå¹¶ä¸”æˆ‘ä»¬æŠŠåŸæ¥èŠ‚ç‚¹Açš„AABBå’Œå¶å­èŠ‚ç‚¹ä¿¡æ¯å¤åˆ¶åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œå³å¯ä¿æŒçˆ¶èŠ‚ç‚¹ä»¥ä¸Šçš„è¿æ¥å…³ç³»ä¸å˜ã€‚ä»¥ä¸Šæ“ä½œå†™æˆä»£ç å°±æ˜¯ï¼š

```c#
public static BVHNode Separate(BVHNode beSeperatedNode)
{
    //step1:æ‰¾åˆ°çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹
    BVHNode parent = beSeperatedNode.parent;
    if (parent != null && parent.Contains(beSeperatedNode))
    {
        BVHNode brother = beSeperatedNode.GetSibling();
        //step2:å°†brotherçš„å†…å®¹å¤åˆ¶åˆ°parentä¸­
        var brotherAABB = brother.aabb;
        parent.SetLeaf(brother.leftNode, brother.rightNode);
        parent.aabb = brotherAABB;
        parent.AABBBroadCast();
        parent.sceneObjects = brother.sceneObjects;

        //step3:åˆ é™¤beSeperatedNodeå’ŒbrotherèŠ‚ç‚¹
        //åº”å½“ä¼šè‡ªå·±GC,æ¯•ç«Ÿæ²¡äººå¼•ç”¨äº†

        return parent;
    }
    Debug.LogError("Separate Error: beSeperatedNode is not a child of parent");
    return null;
}
```



### ï¼ˆ4ï¼‰åŠ¨æ€BVHæ ‘

åœ¨ç¬¬ä¸‰èŠ‚çš„ä¸€å¼€å§‹çš„çº¦å®šéƒ¨åˆ†ï¼Œæˆ‘ä»¬æåˆ°äº†æ­¤æ—¶æ¯ä¸ªå¶å­èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ªç‰©ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨Dictionaryå­˜å‚¨å¥½æ‰€æœ‰å¶å­èŠ‚ç‚¹ä¸ç‰©ä½“çš„æ˜ å°„å…³ç³»ã€‚å‰é¢æˆ‘ä»¬å†™äº†ä¸€ä¸ªBVHSpaceç±»ï¼Œè¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªDynamicBVHSpaceç±»ã€‚å› ä¸ºâ€œåˆå¹¶â€ä¸â€œåˆ é™¤â€ä¼šå‘ç”Ÿæ•°æ®çš„è½¬ç§»ï¼Œæ‰€ä»¥åŒä¸€ä¸ªæ¸¸æˆå¯¹è±¡ï¼Œåœ¨ä¸åŒæ—¶åˆ»ï¼Œå¯èƒ½ä¼šå¯¹åº”ä¸åŒçš„èŠ‚ç‚¹ï¼Œéœ€è¦æˆ‘ä»¬æ›´æ–°ç»´æŠ¤å¥½ã€‚

```c#
public class DynamicBVHSpace
{
    public BVHNode root { get; private set; }
    //ç»´æŠ¤ä¸€ä¸ªå½“å‰bvhçš„æ‰€æœ‰å¶å­ç»“ç‚¹åˆ—è¡¨
    private List<BVHNode> leafs;
    private int generateCount = 0;

    //æ¸¸æˆå¯¹è±¡ä¸èŠ‚ç‚¹çš„æ˜ å°„
    public Dictionary<GameObject, BVHNode> gameObjectToNode;

    public DynamicBVHSpace()
    {
        leafs = new List<BVHNode>();
        gameObjectToNode = new Dictionary<GameObject, BVHNode>();
    }

    //æ›´æ–°ã€è®°å½•æ¸¸æˆå¯¹è±¡ä¸èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»
    private void RecordGameobject(BVHNode node)
    {
        var obj = (node.sceneObjects == null) ? null: node.sceneObjects[0]; //è¿™ç§æƒ…å†µä¸‹åªä¼šæœ‰ä¸€ä¸ªç‰©ä½“
        if (obj != null)
        {
            if (gameObjectToNode.ContainsKey(obj))
            {
                gameObjectToNode[obj] = node;
            }
            else
            {
                gameObjectToNode.Add(obj, node);
            }
        }
    }


    //æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹
    public BVHNode AddNode(GameObject go)
    {
        BVHNode leaf = new BVHNode("leaf_" + generateCount.ToString(), new List<GameObject>(){go});
        RecordGameobject(leaf);
        BuildBVH(leaf);
        generateCount++;
        return leaf;
    }

    //åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹,ä¼ å…¥çš„æ˜¯å¯¹åº”çš„obj
    public void RemoveNode(GameObject go)
    {
        if (gameObjectToNode.TryGetValue(go, out var node))
        {
            //step1:åœ¨leafsä¸­ç§»é™¤ç›®æ ‡èŠ‚ç‚¹åŠå…¶å…„å¼ŸèŠ‚ç‚¹
            leafs.Remove(node);
            leafs.Remove(node.GetSibling()); //å¦‚æœå…„å¼ŸèŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¸ä¼šå½±å“
            //step2:åˆ†ç¦»èŠ‚ç‚¹
            BVHNode subTree = BVHNode.Separate(node); //åˆ†ç¦»åçš„å­æ ‘æ ¹èŠ‚ç‚¹
            //step3:æ›´æ–°æ˜ å°„,ç§»é™¤åæœ‰å¯èƒ½è¿”å›çš„æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯å¶å­èŠ‚ç‚¹
            if (subTree!=null && subTree.isLeaf)
            {
                leafs.Add(subTree);
                RecordGameobject(subTree);
            }
        }
    }

    //æ„å»ºbvh
    public void BuildBVH(BVHNode leaf)
    {
        if (root == null) //ç¬¬ä¸€æ¬¡æ„å»º
        {
            root = leaf;
            leafs.Add(leaf);
            return;
        }
        //step1:æ‰¾åˆ°æœ€ä½³å¶å­èŠ‚ç‚¹
        BVHNode bestLeaf = leafs[0]; //todoï¼šå‡è®¾ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹æ˜¯æœ€ä½³å¶å­èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•æ„å»ºï¼Œåé¢æœ‰ç©ºå†ä¼˜åŒ–
        //step2:åˆå¹¶èŠ‚ç‚¹
        BVHNode newNode = BVHNode.Merge(bestLeaf, leaf);
        //step3:æ›´æ–°å¶å­èŠ‚ç‚¹åˆ—è¡¨
        leafs.Add(leaf);
        leafs.Add(newNode); //æ·»åŠ äº†ä¸¤ä¸ªæ–°çš„
        leafs.Remove(bestLeaf); //åˆ é™¤è€çš„

        //step4ï¼šè®°å½•æ˜ å°„å¹¶æ›´æ–°æ ¹èŠ‚ç‚¹
        RecordGameobject(newNode);
        root = newNode.FindRoot(); //è®°å¾—æ›´æ–°root
    }
}
```

æ­¤æ—¶å°±å¯ä»¥æ·»åŠ ä¸€ä¸ªDynamicBVHTest.csæ–‡ä»¶ï¼Œå°†å…¶ä¿®æ”¹ä¸ºå¯ä»¥åŠ¨æ€æ·»åŠ BVHæ ‘ä¸­çš„ç‰©ä½“å’Œåˆ é™¤BVHæ ‘ä¸­çš„ç‰©ä½“ï¼š

```c#
public class DynamicBVHTest : MonoBehaviour
{
    private DynamicBVHSpace sahSpace;
    private List<GameObject> seneObjects;
    [Range(0, 10)]
    public int displayDepth;

    public GameObject removeObj;

    void Start()
    {
        seneObjects = new List<GameObject>();
        sahSpace = new DynamicBVHSpace();
    }

    private void Update()
    {
        if (Input.GetKeyDown(KeyCode.A)) //Aæ·»åŠ ç‰©ä½“
        {
            var go = GameObject.CreatePrimitive(PrimitiveType.Sphere);
            var randomPos = Random.insideUnitSphere * 10;
            go.transform.position = randomPos;
            sahSpace.AddNode(go);
            seneObjects.Add(go);
        }
        if (Input.GetKeyDown(KeyCode.S)) //Såˆ é™¤ç‰©ä½“
        {
            if (removeObj != null)
            {
                sahSpace.RemoveNode(removeObj);
                Destroy(removeObj);
                seneObjects.Remove(removeObj);
            }
            else
            {
                //éšæœºåˆ é™¤ä¸€ä¸ªç‰©ä½“
                if (seneObjects.Count > 0)
                {
                    var index = Random.Range(0, seneObjects.Count);
                    var obj = seneObjects[index];
                    sahSpace.RemoveNode(obj);
                    seneObjects.RemoveAt(index);
                    Destroy(obj);
                }
            }
        }
    }

    private void OnDrawGizmos()
    {
        sahSpace?.root?.DrawTargetDepth(displayDepth);
    }
}
```

æŒ‚è½½åˆ°åœºæ™¯é‡Œé¢ï¼Œç„¶åå¯ä»¥æŒ‰ä¸‹Aé”®å’ŒSé”®æµ‹è¯•æ•ˆæœã€‚æˆªå›¾å¦‚ä¸‹ï¼š

![image-20241224212200578](./assets/image-20241224212200578.png)

å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æˆ‘ä»¬å¯ä»¥åŠ¨æ€æ·»åŠ èŠ‚ç‚¹è¿›BVHæ ‘ï¼Œä½†æ˜¯æ„å»ºçš„AABBè¿˜æ˜¯ä¼šæœ‰ä¸€äº›ç›¸äº¤çš„ç°è±¡ï¼Œæ„å»ºåœ°å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œè¿™æ˜¯å› ä¸ºæ¯æ¬¡æˆ‘ä»¬éƒ½æ˜¯é€‰æ‹©leaf[0]ä½œä¸ºè¢«æ’å…¥çš„èŠ‚ç‚¹ï¼Œè¿™å…¶å®æ˜¯ä¸å‡†ç¡®çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¼šä»‹ç»SAHç®—æ³•ï¼Œç”¨æ¥åšå‡ºâ€æœ€ä½³çš„é€‰æ‹©â€œã€‚



### ï¼ˆ5ï¼‰SAHç®—æ³•

ä»¥ä¸‹å†…å®¹å‚è€ƒè‡ªGDC2019çš„ä¸€ç¯‡æŠ¥å‘Šï¼š

https://box2d.org/files/ErinCatto_DynamicBVH_GDC2019.pdf

è¿™ç¯‡æŠ¥å‘Šçš„å‰é¢éƒ¨åˆ†ä¹Ÿå€¼å¾—çœ‹ä¸€ä¸‹ï¼ŒåŸºæœ¬å°±æ˜¯å’Œå‰é¢çš„BVHå†…å®¹ç›¸å…³ã€‚

åœ¨â€åŠ¨æ€BVHæ ‘â€œçš„éƒ¨åˆ†æœ‰ä¸€ä¸ªBuildBVHå‡½æ•°ï¼Œè¿™é‡Œæœ‰è¿™æ ·ä¸€å¥ï¼š
```c#
//step1:æ‰¾åˆ°æœ€ä½³å¶å­èŠ‚ç‚¹
BVHNode bestLeaf = leafs[0]; //todoï¼šå‡è®¾ç¬¬ä¸€ä¸ªå¶å­èŠ‚ç‚¹æ˜¯æœ€ä½³å¶å­èŠ‚ç‚¹
```

ä»”ç»†æƒ³æƒ³ï¼Œè¿™å…¶å®æ²¡é“ç†ï¼Œå¦‚æœåªæ˜¯åŸºäºè¿™ç§æ¡ä»¶æ¥åŠ¨æ€ä¸ºBVHæ ‘æ·»åŠ èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šæ„å»ºå‡ºä¸Šå›¾é‚£ç§æ¯”è¾ƒä¸‘çš„BVHåˆ’åˆ†ã€‚é‚£ä¹ˆï¼ŒbestLeafåº”è¯¥æ˜¯åŸºäºä»€ä¹ˆç®—æ³•æ¥é€‰æ‹©çš„å‘¢ï¼Ÿ

> è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ¥è‡ªã€Box2Dã€‘çš„`Dynamic Bounding Volume Hierarchy`ä¸­çš„SAHç®—æ³•[[2\]](https://zhuanlan.zhihu.com/p/697580373#ref_2) ï¼Œä½†å®ç°ä¸Šä¼šæœ‰æ‰€ç²¾ç®€ã€‚

å…ˆæ¥çœ‹çœ‹SAHç®—æ³•çš„ä»‹ç»ï¼ˆä¸Šè¿°pdfçš„ç¬¬32é¡µï¼‰ï¼š

![img](./assets/v2-ef78f47eac8c8d8565fdf088b467bc6c_r.jpg)

SAHç®—æ³•åšäº†ä¸€ä¸ªå¯å‘å¼çš„å‡è®¾ï¼šå³å…‰çº¿å‡»ä¸­AABBçš„æ¦‚ç‡ä¸è¡¨é¢ç§¯æœ‰å…³ï¼ŒAABBçš„è¡¨é¢ç§¯è¶Šå¤§ï¼Œè¢«å…‰çº¿å‡»ä¸­çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚

å¦‚ä½•è®¡ç®—AABBçš„è¡¨é¢ç§¯å‘¢ï¼Ÿåœ¨Box2Dä¸­ä½œè€…ç»™å‡ºäº†è¿™æ ·çš„å…¬å¼ï¼ˆå…¶å®å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯é•¿æ–¹ä½“çš„è¡¨é¢ç§¯ï¼‰ï¼š

```c++
float Area(AABB A)
{
    Vec3 d = A.upperBound - A.lowerBound;
    return 2.0f * (d.x * d.y + d.y * d.z + d.z * d.x);
}
```

æˆ‘ä»¬å°†è®¡ç®—AABB:Açš„è¡¨é¢ç§¯çš„è¿ç®—å®šä¹‰ä¸º$SA(A)$ï¼Œåé¢ä¼šç”¨åˆ°ã€‚æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—ä¸€æ£µæ ‘çš„costï¼Œcostè¢«è®¤ä¸ºæ˜¯æ‰€æœ‰ä¸­é—´èŠ‚ç‚¹çš„AABBçš„è¡¨é¢ç§¯ä¹‹å’Œã€‚ä¹‹æ‰€ä»¥åªæœ‰ä¸­é—´èŠ‚ç‚¹çš„AABBä¼šè¢«è®¡ç®—ï¼Œè€Œä¸éœ€è¦è®¡ç®—å¶å­èŠ‚ç‚¹ï¼Œæ˜¯å› ä¸ºå¯¹äºä¸åŒçš„BVHæ ‘æ„å»ºæ–¹æ³•æ¥è¯´ï¼Œå¾€å¾€å¶å­èŠ‚ç‚¹çš„AABBæ€»å’Œæ˜¯ä¸€æ ·çš„ï¼ˆæ˜¾ç„¶ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹åŒ…å«åœºæ™¯é‡Œçš„ä¸€ä¸ªç‰©ä½“ï¼Œåœºæ™¯é‡Œæœ‰å¤šå°‘ç‰©ä½“ï¼Œå¶å­èŠ‚ç‚¹çš„AABBè¡¨é¢ç§¯æ€»å’Œå°±æ˜¯æ‰€æœ‰ç‰©ä½“AABBçš„è¡¨é¢ç§¯æ€»å’Œï¼‰ã€‚

å› æ­¤ï¼Œä¸€æ£µæ ‘çš„costå¯ä»¥è®¤ä¸ºæ˜¯ï¼š
$$
C(T) = \sum_{i \in InnerNodes} SA(i)
$$
å†™æˆä»£ç å°±æ˜¯ï¼š

```c++
float ComputeCost(Tree tree)
{
    float cost = 0.0f;
    for(int i=0;i<tree.nodeCount;i++)
    {
        if(tree.nodes[i].isLeaf==false)
        {
            cost += Area(tree.nodes[i].box);
        }
    }
    return cost;
}
```

æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ‰€å¸¦æ¥çš„ä»£ä»·äº†ã€‚å½“æˆ‘ä»¬é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹æ—¶ï¼Œåˆ¤æ–­ä¾æ®å°±æ˜¯å“ªä¸€ä¸ªèŠ‚ç‚¹çš„æ’å…¥ä¼šæœ‰â€œæœ€å°è¡¨é¢ç§¯â€çš„å˜åŒ–ã€‚å…¶ä¸­ï¼š

**ã€å˜åŒ–è¡¨é¢ç§¯ã€‘=ã€æ–°å¢çš„åˆ†æ”¯èŠ‚ç‚¹çš„è¡¨é¢ç§¯ã€‘+ã€æ’å…¥åæ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹çš„è¡¨é¢ç§¯å·®ã€‘**ã€‚çœ‹ä¸‹å›¾ï¼š

![image-20241224162600678](./assets/image-20241224162600678.png)

å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æœç´¢è¢«æ’å…¥çš„èŠ‚ç‚¹æ˜¯æ¯”è¾ƒè´¹çš„ï¼Œæ¯”å¦‚å¯¹äºä¸Šå›¾æ¥è¯´ï¼Œä¸­é—´èŠ‚ç‚¹â‘ ~10ï¼Œä»¥åŠå¶å­èŠ‚ç‚¹Aåˆ°Léƒ½æ˜¯å¯ä»¥è¢«æ’å…¥çš„èŠ‚ç‚¹ï¼Œæ€»å…±è¦æœç´¢2n-1æ¬¡ï¼ˆnä¸ªå¶å­èŠ‚ç‚¹ï¼Œn-1ä¸ªä¸­é—´èŠ‚ç‚¹ï¼‰ã€‚åœ¨è€ƒè™‘ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¦¨å…ˆå®ç°ä¸€ä¸‹ç›®å‰çš„å†…å®¹ï¼Œçœ‹çœ‹æ•ˆæœã€‚

> æ³¨ï¼šåœ¨ä¸‹é¢çš„å®ç°ä¸­ï¼Œ**ä¸ºäº†æ–¹ä¾¿ä¸€ç‚¹ï¼Œåªä¼šè€ƒè™‘è®¡ç®—æ·»åŠ åˆ°å“ªä¸ªå¶å­èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå°±æ˜¯åªä¼šéå†æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ã€‚å¦‚æœåé¢è¦è¿›é˜¶çš„è¯å†æ¥è¡¥å……ã€‚**

é¦–å…ˆï¼Œåœ¨AABBç±»ä¸­ï¼Œå¢åŠ å¯¹äºè¡¨é¢ç§¯çš„è®¡ç®—ï¼š

```c#
public float surfaceArea => (Size.x * Size.y + Size.x * Size.z + Size.y * Size.z) * 2.0f;
```

äºæ˜¯BVHNodeä¸­ä¹ŸåŠ å…¥ä¸€ä¸ªè¡¨é¢ç§¯çš„è®¡ç®—ï¼š

```c#
public float surfaceArea => aabb.surfaceArea;
```

åœ¨DynamicBVHSpaceä¸­ï¼Œæ–°å¢SAHæ–¹æ³•ï¼Œå¹¶ä¿®æ”¹BuildBVHå‡½æ•°ï¼š

```c#
private BVHNode findBestLeaf(BVHNode node)
{
    BVHNode bestLeaf = null;
    float minCost = float.MaxValue;
    foreach (var leaf in leafs)
    {
        var leafAABB = new AABB(leaf.aabb); //å¤åˆ¶ä¸€ä¸ªAABB,é¿å…ä¿®æ”¹åŸæ¥çš„AABB,è¿™å°±æ˜¯C#å¼•ç”¨ä¼ é€’çš„ç¦æŠ¥
        var newBranchAABB = AABB.Union(leafAABB, node.aabb);
        //æ–°å¢çš„åˆ†æ”¯èŠ‚ç‚¹è¡¨é¢ç§¯,æ–°å¼•å…¥çš„
        float deltaCost = newBranchAABB.surfaceArea;
        float wholeCost = deltaCost;
        var parent = leaf.parent;

        //ç»Ÿè®¡æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹çš„è¡¨é¢ç§¯å·®
        while (parent != null)
        {
            var s2 = parent.surfaceArea;
            var unionAABB = AABB.Union(parent.aabb, node.aabb);
            var s3 = unionAABB.surfaceArea;
            deltaCost = s3 - s2;  //å¯¹äºçˆ¶èŠ‚ç‚¹é“¾ä¸Šçš„èŠ‚ç‚¹çš„AABBçš„å½±å“
            wholeCost += deltaCost;
            parent = parent.parent;
        }

        //è¿”å›æœ€å°çš„ç›®æ ‡
        if (wholeCost < minCost)
        {
            bestLeaf = leaf;
            minCost = wholeCost;
        }
    }
    return bestLeaf;
}

public void BuildBVH(BVHNode leaf)
{
    //...
    //step1:æ‰¾åˆ°æœ€ä½³å¶å­èŠ‚ç‚¹
    BVHNode bestLeaf = findBestLeaf(leaf);
    if (bestLeaf == null)
    {
        Debug.LogWarning("SAH Can't find best leaf, default to use leaf0");
        bestLeaf = leafs[0];
    }
    //step2:åˆå¹¶èŠ‚ç‚¹
    //...
}
```

æ­¤æ—¶å†æ¬¡è¿è¡Œç¨‹åºï¼Œæ·»åŠ ä¸€äº›ä¸ªèŠ‚ç‚¹ï¼ŒæŸ¥çœ‹BVHæ ‘çš„åˆ›å»ºç»“æœï¼ˆdepth=2ï¼‰ï¼š

![image-20241224212405731](./assets/image-20241224212405731.png)

ä¸‹é¢åˆ™æ˜¯depth=3çš„ç»“æœï¼š

![image-20241224212453394](./assets/image-20241224212453394.png)

å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†SAHçš„å¯å‘å¼ç®—æ³•ä¹‹åï¼ŒBVHæ ‘çš„æ„å»ºæ›´å‡†ç¡®äº†ä¸€äº›ã€‚

> todo:å°šæœªè¡¥å……çš„å†…å®¹ï¼Œåé¢æœ‰æ—¶é—´è¡¥å……ä¸€ä¸‹ï¼š
>
> - ï¼ˆ1ï¼‰åœ¨åšSAHçš„æ—¶å€™ï¼Œæ¯”è¾ƒè´¹ï¼Œéœ€è¦éå†æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ï¼Œè®¡ç®—costçš„æ—¶å€™è¿˜è¦é€’å½’éå†çˆ¶èŠ‚ç‚¹ï¼Œè¿™ç§æ€§èƒ½å¼€é”€ä¸å¤ªèƒ½æ¥å—ï¼Œåé¢çœ‹çœ‹èƒ½å¦ä¼˜åŒ–ï¼Œå‚è€ƒpdfæ–‡ä»¶ï¼›



### ï¼ˆ6ï¼‰ç§»åŠ¨ç‰©ä½“çš„å¤„ç†

å½“ç‰©ä½“ç§»åŠ¨æ›´æ–°ä½ç½®åï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•æ›´æ–°BVHæ ‘å‘¢ï¼Ÿæœ‰å¦‚ä¸‹å‡ ç§ç­–ç•¥ï¼š

- ï¼ˆaï¼‰ä¸æ”¹å˜BVHçš„ç»“æ„ï¼Œé‡æ–°æ²¿ç€çˆ¶èŠ‚ç‚¹å‘ä¸Šæ›´æ–°æ‰€æœ‰çš„AABBï¼›
  - è¿™ç§æ–¹æ³•å¯èƒ½ä¼šå¯¼è‡´åé¢AABBçš„æ•ˆç‡å¾ˆä½ï¼›
- ï¼ˆbï¼‰é‡æ–°åˆ›å»ºå­æ ‘ï¼›
  - è¿™ç§åšæ³•å¾ˆexpensiveï¼ˆç±»ä¼¼äºGCï¼Œè¿™ä¸€ç‚¹åœ¨å‚è€ƒè¿æ¥p57é¡µï¼Œåé¢æ±‚è¯ä¸€ä¸‹ï¼‰ï¼›
- ï¼ˆcï¼‰å¾ˆç®€å•ï¼Œå…ˆåˆ é™¤ç‰©ä½“æ‰€å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œå†æŠŠç‰©ä½“åŠ å…¥åˆ°BVHçš„æ–°çš„ä½ç½®ï¼›
  - ä¾æ—§æ¯”è¾ƒè´¹ï¼Œä½†ç›¸æ¯”ï¼ˆbï¼‰æ–¹æ¡ˆåº”è¯¥ä¼šå¥½ä¸€äº›ã€‚å› æ­¤Box2Dé€‰æ‹©äº†ï¼ˆcï¼‰æ–¹æ³•ä½œä¸ºå¯¹äºç§»åŠ¨ç‰©ä½“çš„å¤„ç†æ–¹æ³•ã€‚

åœ¨Box2Då½“ä¸­ï¼Œè®¤ä¸ºæ¯ä¸€å¸§ç‰©ä½“çš„ç§»åŠ¨æ˜¯ä¸€ä¸ªå¾ˆå°çš„èŒƒå›´ï¼Œå¯ä»¥ç”¨å®½æ¾çš„AABBæ¥åŒ…è£¹ç‰©ä½“ï¼ˆè¿™ä¸€ç‚¹ç±»ä¼¼äºæ¾æ•£å…«å‰æ ‘ï¼‰ã€‚è¿™æ ·ï¼Œå½“ä¸”ä»…å½“ç‰©ä½“çš„ç§»åŠ¨è¶…å‡ºèŠ‚ç‚¹çš„å®½æ¾AABBæ—¶ï¼Œæ‰å‘ç”ŸBVHçš„é‡å»ºã€‚

![image-20241224213852396](./assets/image-20241224213852396.png)

åœ¨ä¸‹é¢çš„ä»£ç å®ç°ä¸­ï¼Œç”±äºæˆ‘ä»¬æ˜¯åšä¸€ä¸ªé€šç”¨çš„BVHï¼Œè¿™é‡Œå°±å…ˆä¸åšæ¾æ•£å¤„ç†äº†ï¼Œåé¢æœ‰æ—¶é—´å†å®Œæˆå¯¹åº”çš„éƒ¨åˆ†ã€‚

ä»£ç ä¿®æ”¹å¦‚ä¸‹ï¼šä¿®æ”¹`RemoveNode`æ–¹æ³•ï¼Œä»¤å…¶è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æˆåŠŸåˆ é™¤èŠ‚ç‚¹ã€‚ç„¶åæ–°å¢UpdateNodeå‡½æ•°ï¼Œé€»è¾‘æ˜¯å…ˆåˆ é™¤èŠ‚ç‚¹ï¼Œå†æ·»åŠ èŠ‚ç‚¹ã€‚æ ¹æ®å‰é¢çš„å­¦ä¹ ï¼Œåˆ é™¤èŠ‚ç‚¹å’Œæ·»åŠ èŠ‚ç‚¹çš„é€»è¾‘éƒ½æ˜¯å†™å¥½äº†çš„ã€‚æ­¤æ—¶UpdateNodeå‡½æ•°å¦‚ä¸‹ï¼ˆ**æ³¨æ„ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæ²¡æœ‰åšæ¾æ•£AABBçš„å¤„ç†**ï¼‰ï¼š

```c#
public void UpdateNode(GameObject go)
{
    if (RemoveNode(go))
    {
        AddNode(go);
    }
}
```

æ­¤æ—¶åœ¨Testç±»é‡Œï¼Œæ–°å¢Updateå‡½æ•°ä¸­çš„é€»è¾‘ï¼Œæ¯tickæ›´æ–°BVHæ ‘ï¼ˆç†è®ºä¸Šï¼Œæˆ‘ä»¬ä¼šåœ¨ç‰©ä½“è¶…å‡ºå®½æ¾AABBèŒƒå›´åæ‰æ›´æ–°BVHæ ‘ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿å°±æ¯tickæ›´æ–°äº†ï¼‰ï¼š

```c#
if(removeObj != null) //ç”¨removeObjæ¥è¡¨ç¤ºè¦ç§»åŠ¨çš„ç‰©ä½“
{
    sahSpace.UpdateNode(removeObj);
}
```

æ­¤æ—¶æ•ˆæœå¦‚ä¸‹ï¼š

<video src="./assets/BVHDemo2.mp4"></video>

å‰©ä¸‹çš„è¡¥å……å†…å®¹åé¢æœ‰ç©ºå†åšè¡¥å……ï¼Œæ¯”å¦‚ä¸€ç§é€€åŒ–æƒ…å†µï¼šå½“é¡ºåºæ’å…¥æ—¶ä¼šè®©BVHæ ‘é€€åŒ–æˆä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€äº›æ–¹æ³•å¹³è¡¡è¿™ä¸ªäºŒå‰æ ‘ã€‚å¸¸ç”¨æ‰‹æ®µå°±æ˜¯â€œæ ‘çš„æ—‹è½¬â€ã€‚



### ï¼ˆ7ï¼‰Branch and Bound ç®—æ³•

åœ¨å‰é¢ä»‹ç»çš„SAHæ–¹æ³•ä¸­ï¼Œæ¯æ¬¡æ’å…¥èŠ‚ç‚¹æ—¶éƒ½è¦æ‰¾åˆ°æœ€ä½³çš„å¶å­èŠ‚ç‚¹ï¼Œéœ€è¦éå†æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹å’Œä¸­é—´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°é€’å½’çš„æ“ä½œï¼Œéå¸¸è´¹ã€‚åœ¨Box2Dä¸­ï¼Œæå‡ºäº†ä¸€ç§ä¼˜åŒ–çš„ç®—æ³•ï¼š**Branch and Bound Algorithm**ï¼Œèƒ½å¤Ÿè®©å…¨å±€æœç´¢çš„é€Ÿåº¦åŠ å¿«ã€‚Branch and Boundç®—æ³•çš„ä¸»è¦æ€æƒ³åœ¨äºï¼š

- ï¼ˆaï¼‰é€’å½’åœ°æœç´¢BVHæ ‘ï¼›
- ï¼ˆbï¼‰è·³è¿‡é‚£äº›â€œä¸ä¼šæ›´å¥½â€çš„å­æ ‘ï¼›

å…·ä½“å®ç°ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—æ¥åšï¼ˆæ€è€ƒï¼šåœ¨Dijkstraç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ€æƒ³æ˜¯ç±»ä¼¼çš„ï¼‰ï¼Œä¸€å¼€å§‹æˆ‘ä»¬å…ˆæŠŠèŠ‚ç‚¹1æ”¾å…¥åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚å‡è®¾ç°åœ¨éå†åˆ°äº†ä¸‹å›¾â‘¦çš„ä¸­é—´èŠ‚ç‚¹ï¼š

![image-20241225104432489](./assets/image-20241225104432489.png)

å¦‚æœ$C_7$æ¯”å½“å‰çš„$C_{best}$è¦æ›´ä½çš„è¯ï¼Œå°±æ›´æ–°$C_{best}$çš„å€¼ä¸º$C_7$ã€‚æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬æœ‰å¿…è¦éå†â‘¦çš„å­æ ‘ä¹ˆï¼Ÿå¯ä»¥å‘ç°ï¼Œâ‘¦çš„ä¸¤ä¸ªå­èŠ‚ç‚¹çš„costçš„ä¸‹ç•Œæ˜¯ï¼š
$$
C_{low}=SA(L)+\Delta SA(7) + \Delta SA(3) + \Delta SA(1)
$$
å…¶ä¸­ï¼Œ$SA(L)$æ˜¯æ–°å¼•å…¥çš„èŠ‚ç‚¹$L$çš„AABBçš„è¡¨é¢ç§¯ï¼Œå…¶ä»–çš„$\Delta$é¡¹åˆ™è¡¨ç¤ºå¯¹åº”èŠ‚ç‚¹çš„AABBè¡¨é¢ç§¯å˜åŒ–é‡ã€‚å¦‚æœè®¡ç®—å‡ºçš„ä¸‹ç•Œ$C_{low}$è¦å°äº$C_{best}$ï¼Œé‚£ä¹ˆå°±æœ‰å¿…è¦æŠŠâ‘¦çš„å¶å­èŠ‚ç‚¹â‘§å’Œâ‘¨åŠ å…¥åˆ°ä¼˜å…ˆé˜Ÿåˆ—å½“ä¸­ï¼›å¦åˆ™çš„è¯å°±å¯ä»¥è¿›è¡Œå‰ªææ“ä½œï¼Œâ‘¦åˆ†æ”¯çš„å­æ ‘ä¸éœ€è¦è¢«è€ƒè™‘è¿›æ¥ã€‚å†å›é¡¾ä¸€ä¸‹$\Delta$çš„è®¡ç®—å…¬å¼ï¼š
$$
âˆ†ğ‘†ğ´ (ğ‘›ğ‘œğ‘‘ğ‘’) = ğ‘†ğ´ (ğ‘›ğ‘œğ‘‘ğ‘’ âˆª ğ¿) âˆ’ ğ‘†ğ´(ğ‘›ğ‘œğ‘‘ğ‘’)
$$
è¯´ç™½äº†ï¼Œä¹‹å‰ä¸ä¼˜åŒ–å‰æˆ‘ä»¬å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªä¸€ä¸ªèŠ‚ç‚¹å»éå†ï¼Œæ‰¾åˆ°æœ€å°çš„costï¼Œè€Œä¼˜åŒ–ä¹‹åæˆ‘ä»¬ä¸€å¼€å§‹ä¼šæŠŠæ ¹èŠ‚ç‚¹â‘ æ”¾å…¥åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸­ï¼Œç„¶åçœ‹çœ‹æ˜¯å¦è¦æ›´æ–°$C_{best}$ï¼Œæ¥ç€æ¯æ¬¡ä»ä¼˜å…ˆé˜Ÿåˆ—ä¸­popä¸€ä¸ªèŠ‚ç‚¹å‡ºæ¥ï¼Œçœ‹å…¶å­èŠ‚ç‚¹çš„ä¸‹é™$C_{low}$æ˜¯å¦æ¯”å½“å‰çš„$C_{best}$æ›´å°ã€‚å¦‚æœæ›´å°çš„è¯ï¼Œå­èŠ‚ç‚¹å°±æ˜¯å€¼å¾—è€ƒè™‘çš„èŠ‚ç‚¹ï¼Œå¯ä»¥æ”¾å…¥åˆ°ä¼˜å…ˆé˜Ÿåˆ—å½“ä¸­ï¼›å¦åˆ™å¯ä»¥ç›´æ¥å‰ªææ‰ã€‚

> åé¢æœ‰æ—¶é—´çš„è¯ï¼Œåœ¨Demoå½“ä¸­å®ç°ä¸€ä¸‹è¿™ä¸ªBranch and Boundç®—æ³•ã€‚



### ï¼ˆ8ï¼‰æ ‘çš„é€€åŒ–æƒ…å†µ

å‡è®¾æˆ‘ä»¬æœ‰ä¸€æ’åœºæ™¯ç‰©ä½“ï¼Œä»–ä»¬å·²ç»æ’å¥½åºï¼Œä¼šé€ä¸ªåŠ å…¥BVHçš„åˆ›å»ºã€‚åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬æ— æ³•é˜»æ­¢è¿™æ ·çš„è¾“å…¥åºåˆ—ã€‚å‡è®¾è¾“å…¥åºåˆ—æ˜¯æ’å¥½åºçš„ABCDEFï¼Œæ­¤æ—¶è¿™é¢—æ ‘å¤§æ¦‚ä¼šå˜æˆä¸‹å›¾æ‰€ç¤ºï¼š

![image-20241225110450616](./assets/image-20241225110450616.png)

è¿™ç§æƒ…å†µä¸‹ï¼ŒSAHç®—æ³•ä¼šç»™æˆ‘ä»¬å¸¦æ¥ä¸ç†æƒ³çš„ç»“æœã€‚è¿™ç§å…¶å®å¹¶éä¸ªä¾‹ï¼Œæ¯”å¦‚ä»¥ä¸‹çš„æ¸¸æˆåœºæ™¯ï¼ˆæˆ‘çš„ç†è§£æ˜¯ä¸‹å›¾çš„æ ‘æœ¬æ¥å°±æ˜¯ä»å·¦å¾€å³ç§æ¤çš„ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šè¢«é¡ºåºåŠ å…¥åˆ°BVHçš„æ„å»ºå½“ä¸­ï¼‰ï¼š

![image-20241225110715169](./assets/image-20241225110715169.png)

**æ­¤æ—¶å¯ä»¥æƒ³åˆ°ä¸€ç§æ•°æ®ç»“æ„è¯¾ä¸Šå­¦åˆ°çš„è§£å†³æ–¹æ¡ˆï¼šå¹³è¡¡äºŒå‰æ ‘ï¼ˆAVL treeï¼‰ã€‚**è¿™é‡Œæ¶‰åŠåˆ°ä¸€äº›æ ‘çš„æ—‹è½¬é—®é¢˜ã€‚å…·ä½“å¯ä»¥çœ‹åŸå‚è€ƒé“¾æ¥çš„p73é¡µå¼€å§‹ï¼š

https://box2d.org/files/ErinCatto_DynamicBVH_GDC2019.pdfã€‚



## 4.æ•´ä¸ªåœºæ™¯

è·Ÿå…«å‰æ ‘å·®ä¸å¤šï¼Œæµ‹è¯•BVHåªéœ€è¦ä¸€ä¸ªç©ºç‰©ä½“ä¸ŠæŒ‚è½½ä¸¤ä¸ªè„šæœ¬å³å¯ï¼š

![image-20241224220659959](./assets/image-20241224220659959.png)

å…¶ä¸­ï¼Œçº¢æ¡†çš„è„šæœ¬æ˜¯é™æ€æ„å»ºã€è‡ªé¡¶å‘ä¸‹çš„BVHæ ‘ï¼Œè€Œæœªè¢«æ¡†èµ·çš„è„šæœ¬åˆ™å¯¹åº”åŠ¨æ€çš„BVHæ ‘ï¼Œæ”¯æŒå¢åŠ ç‰©ä½“ã€å‡å°‘ç‰©ä½“å’Œæ›´æ–°ç§»åŠ¨ç‰©ä½“çš„åŠŸèƒ½ï¼Œä»¥åŠå°†BVHæ ‘çš„ç»“æ„dumpåˆ°æ–‡ä»¶ä¸­çš„åŠŸèƒ½ã€‚ç›¸å…³ä»£ç éƒ½åœ¨è¿™ç¯‡æ–‡æ¡£çš„åŒçº§ç›®å½•ä¸‹ã€‚



## 5.PBRTè¡¥å……